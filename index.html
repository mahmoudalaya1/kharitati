<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>My Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
html,body,#map{height:100%;margin:0;font-family:Arial}
#map{z-index:1}

/* Search */
#searchBar{
  position:absolute;top:12px;left:50%;
  transform:translateX(-50%);
  width:92%;max-width:460px;
  background:white;padding:12px 16px;
  border-radius:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:999
}
#searchBar input{border:none;width:100%;font-size:16px;outline:none}
#results{font-size:14px}

/* Arrow */
#arrow{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  font-size:42px;z-index:998;pointer-events:none
}

/* Bottom Bar */
#bottom{
  position:absolute;bottom:0;left:0;
  width:100%;background:white;
  border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;
  z-index:999
}
#bottom .row{
  display:flex;justify-content:space-around;
  align-items:center
}
#bottom button{
  background:none;border:none;
  font-size:22px;cursor:pointer
}
#info{text-align:center;font-size:14px;margin-bottom:6px}
</style>
</head>

<body>

<div id="map"></div>
<div id="arrow">â¬†ï¸</div>

<!-- Search -->
<div id="searchBar">
  <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†">
  <div id="results"></div>
</div>

<!-- Bottom Bar -->
<div id="bottom">
  <div id="info">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø©</div>
  <div class="row">
    <button onclick="setMode('car')">ğŸš—</button>
    <button onclick="setMode('foot')">ğŸš¶</button>
    <button onclick="setMode('bike')">ğŸš´</button>
    <button onclick="toggleTraffic()">ğŸš¦</button>
    <button onclick="startNav()">â–¶ï¸</button>
    <button onclick="locate()">ğŸ“</button>
    <button onclick="toggleFollow()">ğŸ§­</button>
  </div>
</div>

<script>
/* ================= MAP ================= */
const map = L.map("map",{zoomControl:false}).setView([36.2,37.13],15);
const normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const traffic = L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png");

/* ================= STATE ================= */
let start=null,end=null,route=null,marker=null;
let mode="car",follow=true,trafficOn=false;

/* ================= LOCATION ================= */
navigator.geolocation.watchPosition(
  p=>{
    start = L.latLng(p.coords.latitude,p.coords.longitude);
    if(!marker) marker=L.marker(start).addTo(map);
    else marker.setLatLng(start);

    if(follow) map.setView(start,17,{animate:true});
    if(route && end) route.setWaypoints([start,end]);
  },
  ()=>alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"),
  {enableHighAccuracy:true}
);

/* ================= MODES ================= */
function setMode(m){
  mode=m;
  if(start && end) drawRoute();
}
function profile(){
  if(mode==="foot") return "foot";
  if(mode==="bike") return "bike";
  return "car";
}

/* ================= ROUTING ================= */
function startNav(){
  if(!start || !end){
    alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø«)");
    return;
  }
  drawRoute();
}
function drawRoute(){
  if(route) map.removeControl(route);
  route = L.Routing.control({
    waypoints:[start,end],
    router:L.Routing.osrmv1({profile:profile()}),
    addWaypoints:false,
    show:false
  })
  .on("routesfound",e=>{
    const r=e.routes[0];
    document.getElementById("info").innerText =
      `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${(r.summary.totalDistance/1000).toFixed(1)} ÙƒÙ… â€“ ${(r.summary.totalTime/60).toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©`;
  })
  .addTo(map);
}

/* ================= MAP CLICK ================= */
map.on("click",e=>{
  end = e.latlng;
  document.getElementById("info").innerText="Ø§Ø¶ØºØ· â–¶ï¸ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø©";
});

/* ================= TOOLS ================= */
function locate(){
  if(start) map.setView(start,17,{animate:true});
}
function toggleFollow(){
  follow=!follow;
}
function toggleTraffic(){
  trafficOn ? map.removeLayer(traffic) : map.addLayer(traffic);
  trafficOn=!trafficOn;
}

/* ================= SEARCH ================= */
const search=document.getElementById("search");
const results=document.getElementById("results");

search.oninput=()=>{
  if(search.value.length<3){results.innerHTML="";return;}
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${search.value}`)
  .then(r=>r.json())
  .then(d=>{
    results.innerHTML="";
    d.slice(0,5).forEach(p=>{
      const div=document.createElement("div");
      div.textContent=p.display_name;
      div.onclick=()=>{
        end=L.latLng(p.lat,p.lon);
        map.setView(end,15);
        results.innerHTML="";
        document.getElementById("info").innerText="Ø§Ø¶ØºØ· â–¶ï¸ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø©";
      };
      results.appendChild(div);
    });
  });
};

/* ================= ARROW ================= */
window.addEventListener("deviceorientation",e=>{
  if(e.alpha){
    document.getElementById("arrow").style.transform =
      `translate(-50%,-50%) rotate(${e.alpha}deg)`;
  }
});
</script>

</body>
</html>

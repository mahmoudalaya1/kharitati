<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Chat Friends</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}

/* LOGIN */
#loginBox{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:#ece5dd; z-index:1000;
}
.box{
  background:#fff; padding:20px;
  border-radius:10px; width:300px; text-align:center;
}
.box input{width:100%; padding:10px; margin:5px 0}
.box button{
  width:100%; padding:10px; margin-top:5px;
  border:none; color:#fff; cursor:pointer;
}
.loginBtn{background:#2ecc71}
.registerBtn{background:#3498db}

/* CHAT */
#chatBox{display:none; height:100vh}
.chat{display:flex; height:100%}
.sidebar{width:30%; background:#fff; border-left:1px solid #ccc}
.messages{flex:1; display:flex; flex-direction:column}
.header{background:#075e54; color:#fff; padding:10px; text-align:center}
.list div{padding:10px; border-bottom:1px solid #eee; cursor:pointer}
.msgs{flex:1; padding:10px; overflow:auto}
.msg{background:#dcf8c6; margin:5px; padding:8px; border-radius:6px; max-width:70%}
.me{margin-left:auto; background:#b2f2bb}
.input{display:flex}
.input input{flex:1; padding:10px}
.input button{padding:10px; background:#25d366; border:none; color:#fff}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.appspot.com",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:650a1161841ea510eea2c3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <div class="box">
    <h3>تسجيل / دخول</h3>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <input id="username" placeholder="اسم المستخدم (للتسجيل فقط)">
    <button class="loginBtn" onclick="login()">تسجيل دخول</button>
    <button class="registerBtn" onclick="register()">تسجيل جديد</button>
  </div>
</div>

<!-- CHAT -->
<div id="chatBox">
  <div class="chat">
    <div class="sidebar">
      <div class="header">المستخدمين</div>
      <div class="list" id="friends"></div>
    </div>
    <div class="messages">
      <div class="header" id="chatHeader">اختر صديق</div>
      <div class="msgs" id="msgs"></div>
      <div class="input">
        <input id="text" placeholder="اكتب رسالة">
        <button onclick="send()">إرسال</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentChat=null;

/* AUTH STATE */
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.style.display="none";
    chatBox.style.display="block";
    loadUsers();
  }else{
    loginBox.style.display="flex";
    chatBox.style.display="none";
  }
});

/* LOGIN */
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(err=>alert("خطأ دخول: "+err.message));
}

/* REGISTER */
function register(){
  if(!username.value){
    alert("اكتب اسم المستخدم");
    return;
  }
  auth.createUserWithEmailAndPassword(email.value,pass.value)
  .then(cred=>{
    db.collection("users").doc(cred.user.uid).set({
      username:username.value,
      email:email.value
    });
  })
  .catch(err=>alert("خطأ تسجيل: "+err.message));
}

/* USERS */
function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    friends.innerHTML="";
    s.forEach(d=>{
      if(d.id===auth.currentUser.uid) return;
      const div=document.createElement("div");
      div.innerText=d.data().username;
      div.onclick=()=>openChat(d.id,d.data().username);
      friends.appendChild(div);
    });
  });
}

/* CHAT */
function openChat(fid,name){
  currentChat=[auth.currentUser.uid,fid].sort().join("_");
  chatHeader.innerText=name;
  listen();
}

function send(){
  if(!text.value||!currentChat) return;
  db.collection("chats").doc(currentChat)
  .collection("messages").add({
    text:text.value,
    from:auth.currentUser.uid,
    time:Date.now()
  });
  text.value="";
}

function listen(){
  db.collection("chats").doc(currentChat)
  .collection("messages").orderBy("time")
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      const m=document.createElement("div");
      m.className="msg"+(d.data().from===auth.currentUser.uid?" me":"");
      m.innerText=d.data().text;
      msgs.appendChild(m);
    });
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>BS Chat ðŸ”¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.hidden{display:none}
header{background:#075e54;color:#fff;padding:10px;text-align:center;font-weight:bold}
#app{display:flex;height:100vh}
#users{width:30%;background:#fff;border-left:1px solid #ccc;overflow:auto}
#chat{flex:1;display:flex;flex-direction:column}
.user{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.user:hover{background:#f5f5f5}
.msgs{flex:1;overflow:auto;padding:10px}
.msg{max-width:70%;margin:5px;padding:8px;border-radius:7px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
.footer{display:flex;gap:5px;padding:5px;background:#f0f0f0}
.footer input{flex:1;padding:8px}
.footer button{padding:8px}
small{font-size:11px;color:#666}
.online{color:green}
.offline{color:gray}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.firebasestorage.app",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:e097a1279383dd02eea2c3"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();
</script>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <header>BS Chat ðŸ”¥</header>
  <div style="padding:20px">
    <input id="email" placeholder="Email"><br><br>
    <input id="pass" type="password" placeholder="Password"><br><br>
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£ÙˆÙ„ Ù…Ø±Ø©)"><br><br>
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div id="users"></div>
  <div id="chat">
    <header id="chatHeader">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚</header>
    <div class="msgs" id="msgs"></div>
    <div class="footer">
      <input id="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©â€¦">
      <input type="file" id="file">
      <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<audio id="sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script>
let me=null, current=null, chatId=null;

auth.onAuthStateChanged(u=>{
  if(u){
    me=u;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    setStatus(true);
    loadUsers();
  }
});

window.onbeforeunload=()=>setStatus(false);

function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value)
  .catch(e=>{
    if(e.code==="auth/user-not-found"){
      auth.createUserWithEmailAndPassword(email.value,pass.value)
      .then(c=>{
        const pid=Math.random().toString(36).substring(2,10);
        db.collection("users").doc(c.user.uid).set({
          username:username.value,
          publicId:pid,
          online:true,
          lastSeen:Date.now(),
          blocked:[]
        });
      });
    }
  });
}

function setStatus(on){
  db.collection("users").doc(me.uid).update({
    online:on,
    lastSeen:Date.now()
  });
}

function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id===me.uid) return;
      const u=d.data();
      const div=document.createElement("div");
      div.className="user";
      div.innerHTML=`${u.username}<br>
      <small class="${u.online?'online':'offline'}">
      ${u.online?'ðŸŸ¢ Online':'âšª Last seen '+new Date(u.lastSeen).toLocaleTimeString()}
      </small>`;
      div.onclick=()=>openChat(d.id,u.username);
      users.appendChild(div);
    });
  });
}

function openChat(uid,name){
  current=uid;
  chatId=[me.uid,uid].sort().join("_");
  chatHeader.innerText=name;
  listen();
}

function send(){
  if(!text.value && !file.files[0]) return;
  if(file.files[0]){
    const ref=storage.ref("chat/"+Date.now()+"_"+file.files[0].name);
    ref.put(file.files[0]).then(s=>{
      s.ref.getDownloadURL().then(url=>{
        sendMsg({img:url});
      });
    });
  }else{
    sendMsg({text:text.value});
  }
  text.value="";
  file.value="";
}

function sendMsg(data){
  db.collection("chats").doc(chatId).collection("messages").add({
    ...data,
    from:me.uid,
    to:current,
    time:Date.now(),
    seen:false
  });
}

function listen(){
  db.collection("chats").doc(chatId)
  .collection("messages").orderBy("time")
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.from===me.uid?"me":"other");
      if(m.text) div.innerText=m.text;
      if(m.img) div.innerHTML=`<img src="${m.img}" width="150">`;
      msgs.appendChild(div);
      if(m.from!==me.uid){
        d.ref.update({seen:true});
        sound.play();
      }
    });
    msgs.scrollTop=msgs.scrollHeight;
  });
}
</script>

</body>
</html>

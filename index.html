<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:Arial}
#map{position:fixed;inset:0}

#bottom{
  position:fixed;bottom:0;left:0;width:100%;
  background:white;border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;z-index:1000
}
#info{text-align:center;font-size:14px;margin-bottom:6px}
.row{display:flex;justify-content:space-around;align-items:center}
button{background:none;border:none;font-size:22px;cursor:pointer}
.active{color:#1976d2;font-weight:bold}

.offer-badge{
  background:white;
  padding:4px 6px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  font-size:12px;
  white-space:nowrap
}

#gpsCard{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  padding:14px 18px;
  border-radius:18px;
  box-shadow:0 4px 14px rgba(0,0,0,.3);
  z-index:3000;
  text-align:center;
}
</style>
</head>

<body>

<div id="gpsCard">
  <b>ğŸ“ ØªØ´ØºÙŠÙ„ GPS</b><br>
  <button onclick="enableGPS()"
    style="margin-top:8px;padding:8px 14px;border:none;
    border-radius:14px;background:#1976d2;color:white">
    ØªØ´ØºÙŠÙ„
  </button>
</div>

<div id="map"></div>

<div id="bottom">
  <div id="info">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø©</div>
  <div class="row">
    <button id="walkBtn" onclick="setMode('foot')">ğŸš¶â€â™‚ï¸</button>
    <button id="carBtn" onclick="setMode('car')">ğŸš—</button>
    <button onclick="toggleFollow()">ğŸ§­</button>
    <button onclick="startNav()">â–¶ï¸</button>
    <button onclick="cancelNav()">âŒ</button>
  </div>
</div>

<script>
if(!navigator.geolocation){
  alert("âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
}

/* MAP */
const map = L.map("map").setView([41.05,28.98],15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* STATE */
let start=null,end=null;
let startMarker=null,endMarker=null,routeLine=null;
let mode="foot";
let follow=true;

/* STOP FOLLOW ON MOVE */
map.on("dragstart",()=>follow=false);
map.on("zoomstart",()=>follow=false);

/* GPS */
function enableGPS(){
  navigator.geolocation.getCurrentPosition(
    pos=>{
      start=[pos.coords.latitude,pos.coords.longitude];

      if(!startMarker){
        startMarker=L.marker(start).addTo(map);
      }else{
        startMarker.setLatLng(start);
      }

      map.setView(start,17);
      document.getElementById("gpsCard").style.display="none";
      info.innerText="ØªÙ… ØªØ´ØºÙŠÙ„ GPS âœ”ï¸";

      navigator.geolocation.watchPosition(p=>{
        start=[p.coords.latitude,p.coords.longitude];
        startMarker.setLatLng(start);
        if(follow) map.setView(start,17,{animate:true});
      },console.error,{enableHighAccuracy:true});
    },
    err=>{
      alert("âŒ Ù„Ø§Ø²Ù… ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­");
      console.error(err);
    },
    {enableHighAccuracy:true}
  );
}

/* MODE */
function setMode(m){
  mode=m;
  walkBtn.classList.remove("active");
  carBtn.classList.remove("active");
  if(m==="foot") walkBtn.classList.add("active");
  if(m==="car") carBtn.classList.add("active");
}

/* FOLLOW */
function toggleFollow(){
  follow=!follow;
  info.innerText=follow?"ØªØªØ¨Ø¹ Ù…ÙØ¹Ù‘Ù„":"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹";
}

/* DESTINATION */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];
  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map);
  info.innerText="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© âœ”ï¸";
});

/* ROUTING */
function startNav(){
  if(!start||!end){alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø©");return;}

  const profile=mode==="car"?"driving":"foot";
  const url=`https://router.project-osrm.org/route/v1/${profile}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;

  fetch(url).then(r=>r.json()).then(d=>{
    if(d.code!=="Ok"){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø±");return;}
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(d.routes[0].geometry,{style:{color:"#1976d2",weight:6}}).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
  });
}

function cancelNav(){
  if(routeLine) map.removeLayer(routeLine);
  if(endMarker) map.removeLayer(endMarker);
  routeLine=null; end=null;
  info.innerText="ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡";
}
</script>

</body>
</html>

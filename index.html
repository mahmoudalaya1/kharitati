import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'chat_screen.dart'; // استدعاء صفحة الدردشة التي برمجناها سابقاً

class SearchScreen extends StatefulWidget {
  @override
  _SearchScreenState createState() => _SearchScreenState();
}

class _SearchScreenState extends State<SearchScreen> {
  String searchID = "";
  List searchResults = [];

  // دالة البحث في قاعدة البيانات
  void searchUser(String id) async {
    var result = await FirebaseFirestore.instance
        .collection('users')
        .where('publicId', isEqualTo: id) // البحث عن التطابق في المعرف
        .get();

    setState(() {
      searchResults = result.docs;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Directionality(
      textDirection: TextDirection.rtl, // واجهة عربية
      child: Scaffold(
        appBar: AppBar(title: Text("البحث عن أصدقاء")),
        body: Column(
          children: [
            Padding(
              padding: const EdgeInsets.all(15.0),
              child: TextField(
                onChanged: (val) => searchID = val,
                decoration: InputDecoration(
                  hintText: "أدخل ID الصديق (مثال: user_123)",
                  suffixIcon: IconButton(
                    icon: Icon(Icons.search),
                    onPressed: () => searchUser(searchID),
                  ),
                  border: OutlineInputBorder(borderRadius: BorderRadius.circular(10)),
                ),
              ),
            ),
            Expanded(
              child: ListView.builder(
                itemCount: searchResults.length,
                itemBuilder: (context, index) {
                  var user = searchResults[index];
                  return ListTile(
                    leading: CircleAvatar(child: Icon(Icons.person)),
                    title: Text(user['username']),
                    subtitle: Text(user['publicId']),
                    trailing: ElevatedButton(
                      child: Text("مراسلة"),
                      onPressed: () {
                        // الانتقال لصفحة الدردشة مع هذا المستخدم
                        Navigator.push(context, MaterialPageRoute(builder: (c) => ChatScreen(
                          receiverId: user.id,
                          receiverName: user['username'],
                          chatId: "generated_chat_id", // يجب توليد ID موحد بين الطرفين
                        )));
                      },
                    ),
                  );
                },
              ),
            )
          ],
        ),
      ),
    );
  }
}

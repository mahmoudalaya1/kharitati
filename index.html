<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Chat Friends</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.login,.chat{display:none;height:100vh}
.login{display:flex;align-items:center;justify-content:center}
.box{background:#fff;padding:20px;border-radius:10px;width:300px}
.chat{display:flex}
.sidebar{width:30%;background:#fff;border-left:1px solid #ccc;overflow:auto}
.messages{flex:1;display:flex;flex-direction:column}
.header{background:#075e54;color:#fff;padding:10px;text-align:center}
.list div{padding:10px;cursor:pointer;border-bottom:1px solid #eee}
.list div:hover{background:#f0f0f0}
.msgs{flex:1;padding:10px;overflow:auto}
.msg{background:#dcf8c6;margin:5px;padding:8px;border-radius:6px;max-width:70%;position:relative}
.me{background:#b2f2bb;margin-left:auto}
.small{font-size:11px;color:#555;text-align:left}
.msg button{
  position:absolute;top:2px;left:2px;
  background:red;border:none;color:#fff;font-size:10px;cursor:pointer
}
.input{display:flex}
input{flex:1;padding:10px}
button{padding:10px;background:#25d366;border:none;color:#fff;cursor:pointer}
.logout{background:#d63031;margin-right:5px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.firebasestorage.app",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:650a1161841ea510eea2c3"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <div class="box">
    <h3>ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</h3>
    <input id="email" placeholder="email">
    <input id="pass" type="password" placeholder="password">
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·)">
    <button onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- CHAT -->
<div class="chat" id="chatBox">

<div class="sidebar">
  <div class="header">
    Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    <button class="logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="header">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</div>
  <div class="list" id="requests"></div>

  <div class="header">Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</div>
  <div class="list" id="friends"></div>
</div>

<div class="messages">
  <div class="header" id="chatHeader">
    Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚
    <button class="logout" onclick="deleteChat()">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
  </div>

  <div class="msgs" id="msgs"></div>

  <div class="input">
    <input id="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
    <button onclick="send()">â¤</button>
  </div>
</div>
</div>

<script>
let currentChat=null;

// ================= AUTH =================
auth.onAuthStateChanged(user=>{
  if(user){
    db.collection("users").doc(user.uid).set({
      email:user.email,
      online:true
    },{merge:true});

    showChat();
    loadRequests();
    loadFriends();
  }else{
    showLogin();
  }
});

window.addEventListener("beforeunload",()=>{
  if(auth.currentUser)
    db.collection("users").doc(auth.currentUser.uid).update({online:false});
});

async function doLogin(){
  if(!email.value||!pass.value) return alert("Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

  try{
    await auth.signInWithEmailAndPassword(email.value,pass.value);
  }catch{
    if(!username.value) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…");
    const cred=await auth.createUserWithEmailAndPassword(email.value,pass.value);
    await db.collection("users").doc(cred.user.uid).set({
      username:username.value,
      email:email.value,
      online:true
    });
  }
}

function logout(){
  db.collection("users").doc(auth.currentUser.uid).update({online:false});
  auth.signOut();
}

// ================= FRIEND REQUESTS =================
function loadRequests(){
  db.collection("requests")
  .where("to","==",auth.currentUser.uid)
  .onSnapshot(s=>{
    requests.innerHTML="";
    s.forEach(async d=>{
      const u=await db.collection("users").doc(d.data().from).get();
      const div=document.createElement("div");
      div.innerHTML=`
        ${u.data().username}
        <button onclick="accept('${d.id}','${d.data().from}')">âœ”</button>
        <button onclick="reject('${d.id}')">âœ–</button>`;
      requests.appendChild(div);
    });
  });
}

function accept(id,fid){
  const chatId=[auth.currentUser.uid,fid].sort().join("_");
  db.collection("friends").doc(chatId).set({users:[auth.currentUser.uid,fid]});
  db.collection("requests").doc(id).delete();
}
function reject(id){
  db.collection("requests").doc(id).delete();
}

// ================= FRIENDS =================
function loadFriends(){
  db.collection("friends")
  .where("users","array-contains",auth.currentUser.uid)
  .onSnapshot(async s=>{
    friends.innerHTML="";
    for(const d of s.docs){
      const fid=d.data().users.find(u=>u!==auth.currentUser.uid);
      const u=await db.collection("users").doc(fid).get();
      const div=document.createElement("div");
      div.innerHTML=`
        ${u.data().username} ${u.data().online?"ğŸŸ¢":"âšª"}
      `;
      div.onclick=()=>openChat(d.id,u.data().username);
      div.ondblclick=()=>db.collection("friends").doc(d.id).delete();
      friends.appendChild(div);
    }
  });
}

// ================= CHAT =================
function openChat(id,name){
  currentChat=id;
  chatHeader.firstChild.nodeValue=name;
  listen();
}

function send(){
  if(!text.value||!currentChat) return;
  db.collection("chats").doc(currentChat)
  .collection("messages").add({
    text:text.value,
    from:auth.currentUser.uid,
    time:Date.now(),
    status:"sent"
  });
  text.value="";
}

function listen(){
  db.collection("chats").doc(currentChat)
  .collection("messages").orderBy("time")
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      const m=document.createElement("div");
      const mine=d.data().from===auth.currentUser.uid;
      m.className="msg"+(mine?" me":"");
      m.innerHTML=`
        ${d.data().text}
        ${mine?`<button onclick="deleteMsg('${d.id}')">âœ–</button>`:""}
        <div class="small">${mine?(d.data().status==="seen"?"âœ”âœ”":"âœ”"):""}</div>
      `;
      if(!mine) d.ref.update({status:"seen"});
      msgs.appendChild(m);
    });
  });
}

// Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©
function deleteMsg(id){
  db.collection("chats").doc(currentChat)
  .collection("messages").doc(id).delete();
}

// Ø­Ø°Ù Ù…Ø­Ø§Ø¯Ø«Ø© ÙƒØ§Ù…Ù„Ø©
function deleteChat(){
  if(!currentChat||!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
  db.collection("chats").doc(currentChat)
  .collection("messages").get().then(s=>{
    s.forEach(d=>d.ref.delete());
  });
}
</script>

</body>
</html>

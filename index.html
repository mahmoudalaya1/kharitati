<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ðŸ”¥ BS Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:tahoma;background:#ece5dd}
header{background:#075e54;color:#fff;padding:10px;text-align:center}
#container{display:flex;height:90vh}
#users{width:30%;background:#fff;overflow:auto;border-left:1px solid #ccc}
#chat{width:70%;display:flex;flex-direction:column}
.user{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.user:hover{background:#f1f1f1}
.msgs{flex:1;overflow:auto;padding:10px}
.msg{margin:5px;max-width:70%;padding:8px;border-radius:6px}
.me{background:#dcf8c6;margin-left:auto}
.other{background:#fff}
input,button{padding:8px}
footer{display:flex}
#typing{font-size:12px;color:gray;padding:5px}
.online{color:green;font-size:10px}
.offline{color:gray;font-size:10px}
</style>
</head>

<body>

<header>ðŸ”¥ BS Chat</header>

<div id="container">
  <div id="users"></div>

  <div id="chat">
    <div id="typing"></div>
    <div class="msgs" id="messages"></div>

    <footer>
      <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="flex:1">
      <input type="file" id="img">
      <button onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
    </footer>
  </div>
</div>

<script>
// ðŸ”¥ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.firebasestorage.app",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:e097a1279383dd02eea2c3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let me, currentChat;

// ðŸ” ØªØ³Ø¬ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ (ØªØ¬Ø±Ø¨Ø©)
auth.signInAnonymously().then(u=>{
  me = u.user.uid;
  db.collection("users").doc(me).set({
    online:true,
    lastSeen:firebase.firestore.FieldValue.serverTimestamp(),
    id:me.slice(0,6)
  },{merge:true});
  loadUsers();
});

window.onbeforeunload=()=>{
  if(me) db.collection("users").doc(me).update({
    online:false,
    lastSeen:firebase.firestore.FieldValue.serverTimestamp()
  });
};

// ðŸ‘¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    users.innerHTML="";
    s.forEach(d=>{
      if(d.id!==me){
        users.innerHTML+=`
          <div class="user" onclick="openChat('${d.id}')">
            ${d.data().id}
            <div class="${d.data().online?'online':'offline'}">
              ${d.data().online?'ðŸŸ¢ Online':'âšª Last Seen'}
            </div>
          </div>`;
      }
    });
  });
}

// ðŸ’¬ ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø©
function openChat(id){
  currentChat=[me,id].sort().join("_");
  messages.innerHTML="";
  db.collection("chats").doc(currentChat)
    .collection("msgs")
    .orderBy("t")
    .onSnapshot(s=>{
      messages.innerHTML="";
      s.forEach(m=>{
        let d=m.data();
        messages.innerHTML+=`
          <div class="msg ${d.u===me?'me':'other'}">
            ${d.text||''}
            ${d.img?`<img src="${d.img}" width="150">`:''}
          </div>`;
      });
    });
}

// âœï¸ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function sendMsg(){
  let text=msg.value;
  if(!currentChat) return;
  msg.value="";
  db.collection("chats").doc(currentChat)
    .collection("msgs")
    .add({text,u:me,t:Date.now()});
}

// ðŸ“Ž Ø±ÙØ¹ ØµÙˆØ±Ø©
img.onchange=()=>{
  if(!currentChat) return;
  let f=img.files[0];
  let ref=storage.ref("imgs/"+Date.now()+f.name);
  ref.put(f).then(()=>{
    ref.getDownloadURL().then(url=>{
      db.collection("chats").doc(currentChat)
        .collection("msgs")
        .add({img:url,u:me,t:Date.now()});
    });
  });
};
</script>

</body>
</html>

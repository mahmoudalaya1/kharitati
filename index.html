<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAHMOUD ALAYA NAVIGATION PRO</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        :root { --blue: #4285F4; --red: #EA4335; --gray: #5f6368; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        .leaflet-routing-container { display: none !important; }

        /* شريط البحث العلوي */
        .top-ui { 
            position: fixed; top: 12px; width: 90%; left: 5%; z-index: 2000; 
            background: white; border-radius: 24px; display: flex; align-items: center;
            padding: 5px 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .top-ui input { border: none; flex: 1; padding: 10px; font-size: 16px; outline: none; }

        #suggestions {
            position: fixed; top: 65px; left: 7%; width: 86%; background: white; 
            z-index: 2000; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none; max-height: 250px; overflow-y: auto;
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; text-align: right; }

        /* الأزرار الجانبية والبوصلة */
        .side-btns { position: fixed; right: 15px; bottom: 160px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
        .fab { width: 52px; height: 52px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 10px rgba(0,0,0,0.3); cursor: pointer; color: var(--gray); }

        .compass { position: fixed; left: 15px; top: 85px; z-index: 2000; background: white; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; cursor: pointer; }

        /* اللوحة السفلية للملاحة */
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            z-index: 2100; border-radius: 20px 20px 0 0; padding: 20px;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.2); text-align: center;
            transition: transform 0.4s; transform: translateY(100%);
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        .start-btn { width: 100%; background: var(--blue); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="suggestions"></div>

<div class="top-ui">
    <i class="fas fa-search"></i>
    <input type="text" id="searchInput" placeholder="ابحث أو انقر على الخريطة..." autocomplete="off">
</div>

<div class="compass" id="compassIcon" onclick="resetNorth()"><i class="fas fa-compass" style="color:var(--red)"></i></div>

<div class="side-btns">
    <div class="fab" onclick="changeLayer()"><i class="fas fa-layer-group"></i></div>
    <div class="fab" onclick="getMyLocation()"><i class="fas fa-location-arrow" id="locBtn"></i></div>
</div>

<div class="bottom-sheet" id="navSheet">
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <div style="text-align: right;">
            <div id="placeTitle" style="font-weight: bold; font-size: 18px;">الوجهة المحددة</div>
            <div id="dist-info" style="color:var(--gray)">-- كم</div>
        </div>
        <div id="time-info" style="color:var(--blue); font-size: 20px; font-weight: bold;">-- دقيقة</div>
    </div>
    <button id="mainBtn" class="start-btn" onclick="startRoute()">بدء المشوار ▶️</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
    // تفعيل خيارات الدوران الكامل
    var map = L.map('map', { 
        zoomControl: false,
        dragging: true,
        touchZoom: true,
        boxZoom: true,
        doubleClickZoom: true,
        scrollWheelZoom: true
    }).setView([41.0082, 28.9784], 13);

    var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var userMarker, destMarker, routeControl;

    // الخيار 1: الضغط على الخريطة لتحديد الوجهة
    map.on('click', function(e) {
        setDestination(e.latlng.lat, e.latlng.lng, "موقع مختار على الخريطة");
    });

    function setDestination(lat, lon, name) {
        if(destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([lat, lon]).addTo(map);
        document.getElementById('placeTitle').innerText = name.split(',')[0];
        document.getElementById('navSheet').classList.add('active');
    }

    // الخيار 2: البحث عن وجهة
    const sInput = document.getElementById('searchInput');
    const sBox = document.getElementById('suggestions');
    sInput.addEventListener('input', async (e) => {
        const val = e.target.value;
        if (val.length < 3) { sBox.style.display = 'none'; return; }
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&limit=5`);
        const data = await res.json();
        sBox.innerHTML = '';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.innerText = item.display_name;
            div.onclick = () => {
                setDestination(item.lat, item.lon, item.display_name);
                map.flyTo([item.lat, item.lon], 16);
                sBox.style.display = 'none';
            };
            sBox.appendChild(div);
        });
        sBox.style.display = 'block';
    });

    // حل مشكلة بدء المشوار
    function startRoute() {
        if (!userMarker) {
            alert("يرجى تفعيل الموقع بالسهم أولاً");
            getMyLocation();
            return;
        }
        if (routeControl) map.removeControl(routeControl);

        routeControl = L.Routing.control({
            waypoints: [userMarker.getLatLng(), destMarker.getLatLng()],
            lineOptions: { styles: [{ color: '#1a73e8', weight: 7 }] },
            createMarker: function() { return null; },
            show: false
        }).on('routesfound', function(e) {
            var r = e.routes[0];
            document.getElementById('dist-info').innerText = (r.summary.totalDistance / 1000).toFixed(1) + " كم";
            document.getElementById('time-info').innerText = Math.round(r.summary.totalTime / 60) + " دقيقة";
        }).addTo(map);

        document.getElementById('mainBtn').innerText = "إنهاء المشوار";
        document.getElementById('mainBtn').style.background = "#EA4335";
        document.getElementById('mainBtn').onclick = () => location.reload();
    }

    // تحديد الموقع مع دوران الخريطة
    function getMyLocation() {
        map.locate({setView: true, maxZoom: 16, watch: true, enableHighAccuracy: true});
        document.getElementById('locBtn').style.color = '#4285F4';
    }

    map.on('locationfound', function(e) {
        if(!userMarker) {
            userMarker = L.circleMarker(e.latlng, { radius: 10, fillColor: '#4285F4', color: 'white', fillOpacity: 1, weight: 3 }).addTo(map);
        } else {
            userMarker.setLatLng(e.latlng);
        }
    });

    // دوران البوصلة والخريطة (360 درجة)
    window.addEventListener('deviceorientation', function(e) {
        if(e.webkitCompassHeading) {
            var heading = e.webkitCompassHeading;
            document.getElementById('compassIcon').style.transform = `rotate(${heading}deg)`;
            // هذا الجزء يجعل الخريطة تدور دائرياً بالكامل
            document.getElementById('map').style.transform = `rotate(${-heading}deg)`;
        }
    });

    function resetNorth() {
        document.getElementById('map').style.transform = `rotate(0deg)`;
        document.getElementById('compassIcon').style.transform = `rotate(0deg)`;
    }

    function changeLayer() {
        if(map.hasLayer(streetLayer)) { map.removeLayer(streetLayer); satLayer.addTo(map); }
        else { map.removeLayer(satLayer); streetLayer.addTo(map); }
    }
</script>
</body>
</html>


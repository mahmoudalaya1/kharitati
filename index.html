<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;font-family:Arial}
#map{height:100%}

/* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
#locateBtn{
  position:fixed;
  top:20px;
  right:20px;
  z-index:2000;
  background:white;
  border:none;
  border-radius:50%;
  width:56px;
  height:56px;
  font-size:24px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  cursor:pointer;
}
#toast{
  position:fixed;
  bottom:110px;
  left:50%;
  transform:translateX(-50%);
  background:#333;
  color:#fff;
  padding:10px 16px;
  border-radius:14px;
  font-size:14px;
  opacity:0;
  transition:.3s;
  z-index:5000;
}
#toast.show{opacity:1}

/* Bottom bar */
#bottom{
  position:fixed;
  bottom:0;left:0;width:100%;
  background:white;
  border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;
  z-index:1500;
}
#info{text-align:center;font-size:14px;margin-bottom:6px}
.row{display:flex;justify-content:space-around}
button{background:none;border:none;font-size:22px;cursor:pointer}
.active{color:#1976d2;font-weight:bold}

/* Offer */
.offer-badge{
  background:white;
  padding:4px 6px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  font-size:12px;
}
</style>
</head>
<div id="toast"></div>

<body>

<button id="locateBtn" onclick="enableGPS()">ğŸ“</button>

<div id="map"></div>

<div id="bottom">
  <div id="info">Ø§Ø¶ØºØ· ğŸ“ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ</div>
  <div class="row">
    <button id="walkBtn" onclick="setMode('foot')">ğŸš¶â€â™‚ï¸</button>
    <button id="carBtn" onclick="setMode('car')">ğŸš—</button>
    <button onclick="toggleFollow()">ğŸ§­</button>
    <button onclick="startNav()">â–¶ï¸</button>
    <button onclick="cancelNav()">âŒ</button>
    <button onclick="addOffer()">â•</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.firebasestorage.app",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:650a1161841ea510eea2c3"
};

firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously();
const db = firebase.firestore();

/* ================= MAP ================= */
const map = L.map("map").setView([41.05,28.98],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ================= STATE ================= */
let start=null,end=null;
let startMarker=null,endMarker=null,routeLine=null;
let follow=true;
let mode="foot";

/* ================= GPS ================= */
function enableGPS(){
  if(!navigator.geolocation){
    alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
    return;
  }

  navigator.geolocation.watchPosition(
    p=>{
      start=[p.coords.latitude,p.coords.longitude];

      if(!startMarker){
        startMarker=L.marker(start).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ");
      }else{
        startMarker.setLatLng(start);
      }

      if(follow) map.setView(start,17);
      info.innerText="ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ";
    },
    err=>{
      alert("âŒ Ù„Ø§Ø²Ù… ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­");
      console.error(err);
    },
    {enableHighAccuracy:true}
  );
}

/* ================= FOLLOW ================= */
function toggleFollow(){
  follow=!follow;
  info.innerText=follow?"ğŸ§­ ØªØªØ¨Ø¹ Ù…ÙØ¹Ù‘Ù„":"ğŸ§­ Ø§Ù„ØªØªØ¨Ø¹ Ù…ØªÙˆÙ‚Ù";
}
map.on("dragstart",()=>follow=false);
map.on("zoomstart",()=>follow=false);

/* ================= MODE ================= */
function setMode(m){
  mode=m;
  walkBtn.classList.remove("active");
  carBtn.classList.remove("active");
  if(m==="foot") walkBtn.classList.add("active");
  if(m==="car") carBtn.classList.add("active");
}

/* ================= DEST ================= */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];
  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map).bindPopup("Ø§Ù„ÙˆØ¬Ù‡Ø©");
  info.innerText="ğŸ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø©";
});

/* ================= ROUTE ================= */
function startNav(){
  if(!start||!end){alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø©");return;}

  const profile=mode==="car"?"driving":"foot";
  const url=`https://router.project-osrm.org/route/v1/${profile}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;

  fetch(url).then(r=>r.json()).then(d=>{
    if(d.code!=="Ok"){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø±");return;}
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(d.routes[0].geometry,{style:{color:"#1976d2",weight:6}}).addTo(map);
    info.innerText="â–¶ï¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø¨Ø¯Ø£Øª";
  });
}

function cancelNav(){
  if(routeLine) map.removeLayer(routeLine);
  if(endMarker) map.removeLayer(endMarker);
  routeLine=null;end=null;
  info.innerText="âŒ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡";
}

/* ================= OFFERS ================= */
function addOffer(){
  if(!start){alert("Ø´ØºÙ‘Ù„ GPS Ø£ÙˆÙ„Ø§Ù‹");return;}

  const title=prompt("Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶:");
  if(!title) return;

  db.collection("offers").add({
    title,
    lat:start[0],
    lng:start[1],
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
}

db.collection("offers").onSnapshot(snap=>{
  snap.docChanges().forEach(c=>{
    if(c.type==="added"){
      const o=c.doc.data();
      L.marker([o.lat,o.lng]).addTo(map).bindPopup("ğŸ“¢ "+o.title);
    }
  });
});
</script>

</body>
</html>

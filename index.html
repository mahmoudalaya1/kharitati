<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø®Ø±Ø§Ø¦Ø· Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø¹ÙŠØ§ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --google-blue: #4285F4;
            --google-red: #EA4335;
            --google-green: #34A853;
            --google-yellow: #FBBC05;
            --dark-panel: #202124;
        }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Roboto', sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; background: #f8f9fa; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Auth Overlay) */
        #authOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;
        }
        .auth-card { width: 100%; max-width: 400px; text-align: center; }
        .auth-card img { width: 80px; border-radius: 50%; margin-bottom: 20px; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-primary { background: var(--google-blue); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-ghost { background: transparent; color: #5f6368; border: 1px solid #dadce0; width: 100%; padding: 12px; border-radius: 8px; margin-top: 10px; cursor: pointer; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-ui { position: fixed; top: 12px; width: 94%; left: 3%; z-index: 1000; }
        .search-bar {
            background: white; border-radius: 24px; display: flex; align-items: center;
            padding: 8px 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .search-bar input { border: none; flex: 1; padding: 8px; font-size: 16px; outline: none; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .side-btns { position: fixed; right: 12px; bottom: 120px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }
        .fab {
            width: 48px; height: 48px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); color: #5f6368; cursor: pointer;
        }
        .fab.active { color: var(--google-blue); }
        .btn-go { background: var(--google-blue); color: white; width: 56px; height: 56px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Bottom Sheet) */
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            z-index: 1100; border-radius: 16px 16px 0 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 16px; box-sizing: border-box;
        }
        .sheet-handle { width: 36px; height: 4px; background: #e8eaed; border-radius: 2px; margin: 0 auto 16px; }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø®ØµØµØ© */
        .poi-icon { font-size: 20px; color: white; padding: 5px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .bg-fuel { background: #FF9800; }
        .bg-food { background: #FF5252; }
        .bg-hospital { background: #E91E63; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card">
        <img src="https://via.placeholder.com/80" id="userPhoto" alt="User">
        <h2 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="email" id="email" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="password" class="auth-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-primary" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn-ghost" onclick="toggleAuthMode()" id="toggleBtn">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <div style="margin: 15px 0; color: #70757a;">Ø£Ùˆ</div>
        <button class="btn-ghost" onclick="guestLogin()"><i class="fas fa-user-secret"></i> Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button>
    </div>
</div>

<div class="top-ui">
    <div class="search-bar">
        <i class="fas fa-bars" onclick="openMenu()"></i>
        <input type="text" id="destSearch" placeholder="Ø§Ù„Ø¨Ø­Ø« Ù‡Ù†Ø§ (Ù…Ø·Ø¹Ù…ØŒ ÙˆÙ‚ÙˆØ¯...)">
        <i class="fas fa-microphone" style="color: var(--google-blue);"></i>
    </div>
</div>

<div class="side-btns">
    <div class="fab" onclick="switchLayer()"><i class="fas fa-layer-group"></i></div>
    <div class="fab" onclick="toggleTraffic()"><i class="fas fa-traffic-light"></i></div>
    <div class="fab" onclick="locateMe()"><i class="fas fa-location-crosshairs" id="locIcon"></i></div>
    <div class="fab btn-go" onclick="startNavigation()"><i class="fas fa-directions"></i></div>
</div>

<div class="bottom-sheet" id="infoSheet">
    <div class="sheet-handle"></div>
    <div id="sheetContent">
        <h3 id="placeTitle" style="margin:0">Ø§Ø³ØªÙƒØ´Ù Ø­ÙˆÙ„Ùƒ</h3>
        <p id="placeDesc" style="color:#70757a">Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø© Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø§Ù„Ø­ÙŠØ©</p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-ghost" style="flex:1" onclick="findNearby('gas')">â›½ Ù…Ø­Ø·Ø©</button>
            <button class="btn-ghost" style="flex:1" onclick="findNearby('food')">ğŸ´ Ù…Ø·Ø¹Ù…</button>
        </div>
    </div>
</div>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§)
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "ID",
        appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    var map = L.map('map', { zoomControl: false }).setView([24.7136, 46.6753], 13);
    
    var layers = {
        street: L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map),
        sat: L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{ subdomains:['mt0','mt1','mt2','mt3'] }),
        traffic: L.tileLayer('https://{s}.google.com/vt/lyrs=m,traffic&x={x}&y={y}&z={z}',{ subdomains:['mt0','mt1','mt2','mt3'] })
    };

    // 3. Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØµØµØ© (Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø§Ù„Ø³Ù‡Ù… - Ø§Ù„Ø¯Ø¨ÙˆØ³)
    var userIcon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background:var(--google-blue); width:15px; height:15px; border-radius:50%; border:3px solid white; box-shadow:0 0 5px rgba(0,0,0,0.5);'></div>" });
    var userMarker = L.marker([0,0], {icon: userIcon}).addTo(map);
    var isSignUp = false;

    // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø­Ù‚ÙŠÙ‚ÙŠ)
    function toggleAuthMode() {
        isSignUp = !isSignUp;
        document.getElementById('authTitle').innerText = isSignUp ? "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯" : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        document.getElementById('toggleBtn').innerText = isSignUp ? "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„" : "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨";
    }

    function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if(isSignUp) {
            auth.createUserWithEmailAndPassword(email, pass).then(u => finishAuth());
        } else {
            auth.signInWithEmailAndPassword(email, pass).then(u => finishAuth()).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"));
        }
    }

    function guestLogin() { finishAuth(); }

    function finishAuth() {
        document.getElementById('authOverlay').classList.add('hidden');
        locateMe();
    }

    // 5. Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    var routingControl;
    function startNavigation() {
        if(routingControl) map.removeControl(routingControl);
        
        // ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Ø§Ù„Ø±ÙŠØ§Ø¶ Ø¨Ø§Ø±Ùƒ Ù…Ø«Ù„Ø§Ù‹)
        var dest = [24.7578, 46.6322]; 
        
        routingControl = L.Routing.control({
            waypoints: [userMarker.getLatLng(), L.latLng(dest)],
            lineOptions: { styles: [{ color: '#4285F4', weight: 7 }] },
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
            createMarker: function(i, wp) {
                return L.marker(wp.latLng, { draggable: true, icon: L.divIcon({html: '<i class="fas fa-map-marker-alt" style="color:var(--google-red); font-size:30px;"></i>', className:''}) });
            }
        }).addTo(map);
        
        document.getElementById('placeTitle').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø©...";
        document.getElementById('placeDesc').innerText = "Ø§ØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„ÙˆØµÙˆÙ„ Ù„ÙˆØ¬Ù‡ØªÙƒ";
    }

    // 6. Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª
    function locateMe() {
        map.locate({setView: true, maxZoom: 16, watch: true, enableHighAccuracy: true});
    }

    map.on('locationfound', (e) => {
        userMarker.setLatLng(e.latlng);
        // ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firestore (Ø­Ù‚ÙŠÙ‚ÙŠ)
        if(auth.currentUser) {
            db.collection("live_locations").doc(auth.currentUser.uid).set({
                coords: new firebase.firestore.GeoPoint(e.latlng.lat, e.latlng.lng),
                time: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    });

    function switchLayer() {
        if(map.hasLayer(layers.street)) { map.removeLayer(layers.street); layers.sat.addTo(map); }
        else { map.removeLayer(layers.sat); layers.street.addTo(map); }
    }

    function toggleTraffic() {
        if(map.hasLayer(layers.traffic)) map.removeLayer(layers.traffic);
        else layers.traffic.addTo(map);
    }
</script>
</body>
</html>


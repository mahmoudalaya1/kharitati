<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Live Navigation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%}
#map{height:100%}

/* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ */
#locateBtn{
  position:fixed;
  bottom:90px;
  right:16px;
  z-index:1000;
  background:white;
  border:none;
  border-radius:50%;
  width:56px;
  height:56px;
  font-size:24px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  cursor:pointer;
}

/* Ø³Ù‡Ù… Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
.arrow{
  width:0;height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:22px solid #1976d2;
  transform-origin:center;
}

/* Ø¹Ø±Ø¶ */
.offer{
  background:white;
  padding:4px 6px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  font-size:12px;
  white-space:nowrap;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="locateBtn" onclick="centerOnMe()">ğŸ“</button>

<script>
/* ================= MAP ================= */
const map = L.map("map").setView([41.05,28.98],15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ================= STATE ================= */
let userMarker=null;
let follow=true;
let lastHeading=0;
let destination=null;
let routeLine=null;

/* ================= ICON ================= */
const arrowIcon=L.divIcon({
  className:"",
  html:`<div class="arrow"></div>`,
  iconSize:[22,22],
  iconAnchor:[11,11]
});

/* ================= STOP FOLLOW ================= */
map.on("dragstart",()=>follow=false);
map.on("zoomstart",()=>follow=false);

/* ================= GPS ================= */
navigator.geolocation.watchPosition(
 pos=>{
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  const heading=pos.coords.heading ?? lastHeading;
  lastHeading=heading;

  if(!userMarker){
    userMarker=L.marker([lat,lng],{icon:arrowIcon}).addTo(map);
    map.setView([lat,lng],17);
  }else{
    userMarker.setLatLng([lat,lng]);
  }

  // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø³Ù‡Ù…
  const el=userMarker.getElement();
  if(el) el.style.transform=`rotate(${heading}deg)`;

  // Follow
  if(follow) map.setView([lat,lng],map.getZoom(),{animate:true});

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  if(destination) updateRoute([lat,lng],destination);
 },
 err=>alert("âŒ Ù„Ø§Ø²Ù… ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹"),
 {enableHighAccuracy:true}
);

/* ================= CENTER ================= */
function centerOnMe(){
 follow=true;
 if(userMarker) map.setView(userMarker.getLatLng(),17);
}

/* ================= DESTINATION ================= */
map.on("click",e=>{
 destination=[e.latlng.lat,e.latlng.lng];
 updateRoute(userMarker.getLatLng(),destination);
});

/* ================= LIVE ROUTING ================= */
function updateRoute(start,end){
 const url=`https://router.project-osrm.org/route/v1/foot/${start.lng},${start.lat};${end[1]},${end[0]}?overview=full&geometries=geojson`;

 fetch(url).then(r=>r.json()).then(d=>{
  if(d.code!=="Ok") return;
  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.geoJSON(d.routes[0].geometry,{
    style:{color:"#1976d2",weight:6}
  }).addTo(map);
 });
}

/* ================= OFFERS (ÙŠÙ…ÙŠÙ† / ÙŠØ³Ø§Ø±) ================= */
const offers=[
 {lat:41.051,lng:28.981,title:"Ø¨ÙŠØ¹ Ø¯ÙƒØ§Ù†",side:"right"},
 {lat:41.049,lng:28.979,title:"ØªØ£Ø¬ÙŠØ± Ù…Ø­Ù„",side:"left"},
 {lat:41.052,lng:28.978,title:"Ø¨Ø§Ø¦Ø¹ Ø®Ø¶Ø§Ø±",side:"front"}
];

function offerIcon(o){
 const arrow=o.side==="right"?"â¡ï¸":o.side==="left"?"â¬…ï¸":"â¬†ï¸";
 return L.divIcon({
  className:"",
  html:`<div class="offer">${arrow} ${o.title}</div>`
 });
}

offers.forEach(o=>{
 L.marker([o.lat,o.lng],{icon:offerIcon(o)}).addTo(map);
});
</script>

</body>
</html>

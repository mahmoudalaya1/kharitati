<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Chat Friends</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.login,.chat{display:none;height:100vh}
.login{display:flex;align-items:center;justify-content:center}
.box{background:#fff;padding:20px;border-radius:10px;width:300px}
.chat{display:flex}
.sidebar{width:30%;background:#fff;border-left:1px solid #ccc}
.messages{flex:1;display:flex;flex-direction:column}
.header{background:#075e54;color:#fff;padding:10px;text-align:center}
.list div{padding:10px;cursor:pointer;border-bottom:1px solid #eee}
.list div:hover{background:#f0f0f0}
.msgs{flex:1;padding:10px;overflow:auto}
.msg{background:#dcf8c6;margin:5px;padding:8px;border-radius:6px;max-width:70%}
.input{display:flex}
input{flex:1;padding:10px;margin-bottom:5px}
button{padding:10px;background:#25d366;border:none;color:#fff;cursor:pointer}
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ğŸ”¥ Firebase config (Ù…Ù† Web App)
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.firebasestorage.app",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:650a1161841ea510eea2c3"
};
// ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function loadAllUsers(){
  db.collection("users").onSnapshot(snap=>{
    allUsers.innerHTML="";
    snap.forEach(d=>{
      if(d.id === auth.currentUser.uid) return;

      const div = document.createElement("div");
      div.innerText = "â• " + d.data().username;
      div.onclick = ()=>addFriendById(d.id);
      allUsers.appendChild(div);
    });
  });
}

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
</script>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <div class="box">
    <h3>ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</h3>
    <input id="email" placeholder="email">
    <input id="pass" type="password" placeholder="password">
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙ‚Ø·)">
    <button onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- CHAT -->
<div class="chat" id="chatBox">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="header">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</div>

<div class="header">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
<div class="list" id="allUsers"></div>


    <div class="list" id="searchResults"></div>

    <div class="header">Ù‚Ø§Ø¦Ù…Ø© Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</div>
    <div class="list" id="friends"></div>
  </div>

  <!-- MESSAGES -->
  <div class="messages">
    <div class="header" id="chatHeader">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚</div>
    <div class="msgs" id="msgs"></div>
    <div class="input">
      <input id="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
      <button onclick="send()">â¤</button>
    </div>
  </div>
</div>

<script>
let currentChat = null;

// Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
auth.onAuthStateChanged(user=>{
  if(user){
    saveUser();
    showChat();
    loadFriends();
  }else{
    showLogin();
  }
});

// ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„
function doLogin(){
  if(!email.value || !pass.value){
    alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    return;
  }

  auth.signInWithEmailAndPassword(email.value, pass.value)
  .catch(()=>{
    if(!username.value){
      alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ³Ø¬ÙŠÙ„");
      return;
    }
    return auth.createUserWithEmailAndPassword(email.value, pass.value);
  });
}

// Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function saveUser(){
  if(!username.value) return;
  db.collection("users").doc(auth.currentUser.uid).set({
    username: username.value,
    email: auth.currentUser.email
  },{merge:true});
}

// ÙˆØ§Ø¬Ù‡Ø©
function showLogin(){
  loginBox.style.display="flex";
  chatBox.style.display="none";
}
function showChat(){
  loginBox.style.display="none";
  chatBox.style.display="flex";
}

// ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…
async function searchUser(){
  const name = searchName.value.trim();
  searchResults.innerHTML="";

  if(!name){
    alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…");
    return;
  }

  const q = await db.collection("users")
    .where("username","==",name).get();

  if(q.empty){
    searchResults.innerHTML="<div>âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…</div>";
    return;
  }

  q.forEach(d=>{
    if(d.id===auth.currentUser.uid) return;
    const div=document.createElement("div");
    div.innerText="â• "+d.data().username;
    div.onclick=()=>addFriendById(d.id);
    searchResults.appendChild(div);
  });
}

// Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚
async function addFriendById(friendId){
  const myId=auth.currentUser.uid;
  const chatId=[myId,friendId].sort().join("_");

  await db.collection("friends").doc(chatId).set({
    users:[myId,friendId]
  });

  alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚");
  searchResults.innerHTML="";
  searchName.value="";
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
function loadFriends(){
  db.collection("friends")
  .where("users","array-contains",auth.currentUser.uid)
  .onSnapshot(async snap=>{
    friends.innerHTML="";
    for(const d of snap.docs){
      const fid=d.data().users.find(u=>u!==auth.currentUser.uid);
      const u=await db.collection("users").doc(fid).get();
      const div=document.createElement("div");
      div.innerText=u.data().username;
      div.onclick=()=>openChat(d.id,u.data().username);
      friends.appendChild(div);
    }
  });
}

// ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø©
function openChat(id,name){
  currentChat=id;
  chatHeader.innerText=name;
  listen();
}

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
function send(){
  if(!text.value || !currentChat) return;
  db.collection("chats").doc(currentChat)
  .collection("messages").add({
    text:text.value,
    user:auth.currentUser.uid,
    time:Date.now()
  });
  text.value="";
}

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
function listen(){
  db.collection("chats").doc(currentChat)
  .collection("messages").orderBy("time")
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      const m=document.createElement("div");
      m.className="msg";
      m.innerText=d.data().text;
      msgs.appendChild(m);
    });
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{height:100%}

/* ===== Search ===== */
#searchBar{
  position:fixed;
  top:14px;left:50%;
  transform:translateX(-50%);
  width:90%;
  z-index:3000;
}
#searchInput{
  width:100%;
  padding:12px 16px;
  border:none;
  border-radius:14px;
  font-size:15px;
  box-shadow:0 6px 18px rgba(0,0,0,.25);
}

/* ===== Floating Buttons ===== */
#fab{
  position:fixed;
  right:14px;
  bottom:140px;
  display:flex;
  flex-direction:column;
  gap:12px;
  z-index:3000;
}
#fab button{
  width:48px;height:48px;
  border:none;
  border-radius:50%;
  background:#fff;
  font-size:22px;
  box-shadow:0 6px 18px rgba(0,0,0,.25);
  cursor:pointer;
}

/* ===== Bottom Sheet ===== */
#bottomSheet{
  position:fixed;
  left:0;right:0;bottom:0;
  background:#fff;
  border-radius:22px 22px 0 0;
  box-shadow:0 -6px 24px rgba(0,0,0,.25);
  padding:12px 16px 24px;
  z-index:2500;
}
#sheetHandle{
  width:44px;height:5px;
  background:#ccc;
  border-radius:4px;
  margin:0 auto 10px;
}
#navTitle{font-weight:bold;font-size:16px}
#navInfo{font-size:14px;color:#666;margin-top:6px}

/* ===== Weather Box ===== */
#weatherBox{
  position:fixed;
  top:80px;left:50%;
  transform:translateX(-50%);
  background:#fff;
  padding:14px 18px;
  border-radius:16px;
  box-shadow:0 6px 20px rgba(0,0,0,.3);
  display:none;
  z-index:4000;
  font-size:14px;
}

/* ===== Arrow ===== */
.arrow{
  width:0;height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:22px solid #2d7cff;
  transform-origin:center;
}
</style>
</head>

<body>

<!-- Search -->
<div id="searchBar">
  <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†">
</div>

<!-- Floating Buttons -->
<div id="fab">
  <button id="locBtn">ğŸ“</button>
  <button id="navBtn">â–¶ï¸</button>
  <button id="shareBtn">ğŸ“¤</button>
  <button id="weatherBtn">ğŸŒ¦ï¸</button>
  <button id="tourBtn">ğŸ§­</button>
</div>

<!-- Weather -->
<div id="weatherBox">
  <b>Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ</b>
  <div id="weatherInfo" style="margin-top:8px"></div>
</div>

<!-- Bottom Sheet -->
<div id="bottomSheet">
  <div id="sheetHandle"></div>
  <div id="navTitle">Ø¬Ø§Ù‡Ø²</div>
  <div id="navInfo">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø«Ù… Ø§Ø®ØªØ± ÙˆØ¬Ù‡Ø©</div>
</div>

<div id="map"></div>

<script>
/* ===== Map ===== */
const map = L.map("map",{zoomControl:true})
  .setView([41.05,28.98],14);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  {maxZoom:19}
).addTo(map);

/* ===== State ===== */
let start=null,end=null;
let arrowMarker=null,endMarker=null,routeLine=null;
let lastPos=null,watchId=null;

/* ===== GPS ===== */
locBtn.onclick=()=>{
  if(watchId) return;
  watchId = navigator.geolocation.watchPosition(p=>{
    start=[p.coords.latitude,p.coords.longitude];

    if(!arrowMarker){
      arrowMarker=L.marker(start,{
        icon:L.divIcon({
          className:"",
          html:'<div class="arrow"></div>',
          iconSize:[22,22],
          iconAnchor:[11,11]
        })
      }).addTo(map);
    }else{
      arrowMarker.setLatLng(start);
    }

    if(lastPos){
      const angle=Math.atan2(
        start[1]-lastPos[1],
        start[0]-lastPos[0]
      )*180/Math.PI;
      const el=arrowMarker.getElement();
      if(el) el.style.transform=`rotate(${angle}deg)`;
    }

    lastPos=[...start];
    map.setView(start,17);
    navInfo.innerText="ğŸ“ ØªØªØ¨Ø¹ Ø­ÙŠ Ù…ÙØ¹Ù‘Ù„";
  },()=>alert("Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹"),{enableHighAccuracy:true});
};

/* ===== Destination ===== */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];
  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map);
  navInfo.innerText="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©";
});

/* ===== Route ===== */
navBtn.onclick=()=>{
  if(!start||!end){alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø©");return;}
  fetch(`https://router.project-osrm.org/route/v1/foot/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`)
  .then(r=>r.json())
  .then(d=>{
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(d.routes[0].geometry,{
      style:{color:"#2d7cff",weight:6}
    }).addTo(map);
    navTitle.innerText="Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø¨Ø¯Ø£Øª";
    navInfo.innerText="Ø§ØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±";
  });
};

/* ===== Share ===== */
shareBtn.onclick=()=>{
  if(!start) return alert("Ø´ØºÙ‘Ù„ GPS");
  const link=`https://www.google.com/maps?q=${start[0]},${start[1]}`;
  navigator.clipboard.writeText(link);
  alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ");
};

/* ===== Search ===== */
searchInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchInput.value}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±");
      map.setView([d[0].lat,d[0].lon],16);
    });
  }
});

/* ===== Weather ===== */
weatherBtn.onclick=()=>{
  if(!start) return alert("Ø´ØºÙ‘Ù„ GPS");
  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${start[0]}&longitude=${start[1]}&current_weather=true`)
  .then(r=>r.json())
  .then(d=>{
    const w=d.current_weather;
    weatherInfo.innerHTML=`
      ğŸŒ¡ï¸ ${w.temperature}Â°C<br>
      ğŸ’¨ Ø±ÙŠØ§Ø­ ${w.windspeed} ÙƒÙ…/Ø³<br>
      ğŸ§­ Ø§ØªØ¬Ø§Ù‡ ${w.winddirection}Â°
    `;
    weatherBox.style.display=
      weatherBox.style.display==="block"?"none":"block";
  });
};

/* ===== Virtual Tour ===== */
tourBtn.onclick=()=>{
  const c=map.getCenter();
  window.open(`https://kartaview.org/map/@${c.lat},${c.lng},18z`,"_blank");
};
</script>

</body>
</html>

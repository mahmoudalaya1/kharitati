<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
    authDomain: "kharitati-5cb37.firebaseapp.com",
    projectId: "kharitati-5cb37",
    storageBucket: "kharitati-5cb37.firebasestorage.app",
    messagingSenderId: "296218682746",
    appId: "1:296218682746:web:e097a1279383dd02eea2c3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
</script>

<button id="googleLogin">تسجيل الدخول باستخدام Google</button>
<button id="logout" style="display:none">تسجيل الخروج</button>

<script type="module">
  const provider = new GoogleAuthProvider();

  document.getElementById("googleLogin").onclick = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      // إنشاء / تحديث المستخدم في Firestore
      await setDoc(doc(db, "users", user.uid), {
        uid: user.uid,
        name: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        online: true,
        lastSeen: serverTimestamp(),
        createdAt: serverTimestamp()
      }, { merge: true });

      alert("تم تسجيل الدخول ✅");
    } catch (e) {
      console.error(e);
      alert("خطأ بتسجيل الدخول");
    }
  };

  document.getElementById("logout").onclick = async () => {
    await signOut(auth);
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("googleLogin").style.display = "none";
      document.getElementById("logout").style.display = "block";
      console.log("مستخدم مسجل:", user.uid);
    } else {
      document.getElementById("googleLogin").style.display = "block";
      document.getElementById("logout").style.display = "none";
    }
  });
</script>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø®Ø±ÙŠØ·ØªÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Search -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{height:100%}

/* ===== AppBar ===== */
#appBar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#2f3f9e;color:#fff;
  display:flex;align-items:center;
  padding:0 12px;z-index:2000
}
#title{flex:1;font-weight:bold}

/* ===== Buttons ===== */
.btn{
  position:fixed;right:14px;
  width:46px;height:46px;
  border-radius:50%;
  border:none;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  font-size:20px;
  cursor:pointer;
  z-index:1500
}
#locate{top:80px}
#startNav{top:136px;background:#ff9800;color:#fff}
#share{top:192px}
#layers{top:248px}

/* ===== User Dot ===== */
.user-dot{
  width:16px;height:16px;
  background:#2979ff;
  border:3px solid #fff;
  border-radius:50%;
  box-shadow:0 0 0 8px rgba(41,121,255,.3)
}
</style>
</head>

<body>

<div id="appBar">
  <div id="title">MAHMOUD ALAYA</div>
</div>

<button id="locate" class="btn">ğŸ“</button>
<button id="startNav" class="btn">â–¶</button>
<button id="share" class="btn">ğŸ“¤</button>
<button id="layers" class="btn">ğŸ—ºï¸</button>

<div id="map"></div>

<script>
// ================== MAP ==================
const normal = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  {maxZoom:19}
);

const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {maxZoom:19}
);

const terrain = L.tileLayer(
  'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
  {maxZoom:17}
);

const map = L.map('map',{
  zoomControl:true,
  layers:[normal]
}).setView([36.2021,37.1343],13);

L.control.layers({
  "ğŸ—ºï¸ Ø¹Ø§Ø¯ÙŠ": normal,
  "ğŸ›°ï¸ Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ": satellite,
  "ğŸ”ï¸ ØªØ¶Ø§Ø±ÙŠØ³": terrain
}).addTo(map);

// ================== SEARCH ==================
L.Control.geocoder({
  defaultMarkGeocode:true
}).addTo(map);

// ================== GPS FOLLOW ==================
let userMarker=null;
let watchId=null;
let routeLine=null;
let startPoint=null;
let destPoint=null;

locate.onclick=()=>{
  if(watchId) return;
  watchId = navigator.geolocation.watchPosition(p=>{
    const latlng=[p.coords.latitude,p.coords.longitude];
    startPoint=latlng;

    if(!userMarker){
      userMarker=L.marker(latlng,{
        icon:L.divIcon({
          className:'',
          html:'<div class="user-dot"></div>',
          iconSize:[16,16]
        })
      }).addTo(map);
    }else{
      userMarker.setLatLng(latlng);
    }
    map.setView(latlng,17);
    updateRoute();
  },err=>alert("ÙØ¹Ù‘Ù„ GPS"));
};

// ================== ROUTE ==================
map.on("click",e=>{
  destPoint=[e.latlng.lat,e.latlng.lng];
  updateRoute();
});

function updateRoute(){
  if(!startPoint||!destPoint) return;

  fetch(`https://router.project-osrm.org/route/v1/foot/${startPoint[1]},${startPoint[0]};${destPoint[1]},${destPoint[0]}?overview=full&geometries=geojson`)
  .then(r=>r.json()).then(d=>{
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(d.routes[0].geometry,{
      style:{color:"#2979ff",weight:6}
    }).addTo(map);
  });
}

startNav.onclick=()=>updateRoute();

// ================== SHARE ==================
share.onclick=()=>{
  if(!startPoint) return alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
  const link=`https://maps.google.com/?q=${startPoint[0]},${startPoint[1]}`;
  navigator.clipboard.writeText(link);
  alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ");
};
</script>

</body>
</html>

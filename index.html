<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:Arial}
#map{position:fixed;inset:0}

/* Bottom bar */
#bottom{
  position:fixed;bottom:0;left:0;width:100%;
  background:white;border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;z-index:1000
}
#info{text-align:center;font-size:14px;margin-bottom:6px}
.row{display:flex;justify-content:space-around;align-items:center}
button{background:none;border:none;font-size:22px;cursor:pointer}
.active{color:#1976d2;font-weight:bold}

/* Offer badge */
.offer-badge{
  background:white;
  padding:4px 6px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  font-size:12px;
  white-space:nowrap
}

/* Modal */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:center;justify-content:center;z-index:2000
}
.modal-content{
  background:white;padding:20px;border-radius:16px;width:90%;max-width:320px
}
.modal-content input,select{
  width:100%;margin:6px 0;padding:8px
}
</style>
</head>

<body>

  <div id="gpsCard" style="
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  padding:14px 18px;
  border-radius:18px;
  box-shadow:0 4px 14px rgba(0,0,0,.3);
  z-index:3000;
  text-align:center;
">
  <b>ğŸ“ ØªØ´ØºÙŠÙ„ GPS</b><br>
  <button onclick="enableGPS()" style="
    margin-top:8px;
    padding:8px 14px;
    border:none;
    border-radius:14px;
    background:#1976d2;
    color:white;
    font-size:16px;
    cursor:pointer;
  ">ØªØ´ØºÙŠÙ„</button>
</div>

<div id="map"></div>

<div id="bottom">
  <div id="info">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø©</div>
  <div class="row">
    <button id="walkBtn" onclick="setMode('foot')">ğŸš¶â€â™‚ï¸</button>
    <button id="carBtn" onclick="setMode('car')">ğŸš—</button>
    <button onclick="toggleFollow()">ğŸ§­</button>
    <button onclick="startNav()">â–¶ï¸</button>
    <button onclick="cancelNav()">âŒ</button>
    <button onclick="openOffer()">â•</button>
  </div>
</div>

<!-- Offer Modal -->
<div class="modal" id="offerModal">
  <div class="modal-content">
    <h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶</h3>
    <input id="offerTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙŠØ¹ Ø¯ÙƒØ§Ù†">
    <select id="offerSide">
      <option value="right">ÙŠÙ…ÙŠÙ† Ø§Ù„Ø·Ø±ÙŠÙ‚</option>
      <option value="left">ÙŠØ³Ø§Ø± Ø§Ù„Ø·Ø±ÙŠÙ‚</option>
      <option value="front">Ø£Ù…Ø§Ù…Ùƒ</option>
    </select>
    <button onclick="saveOffer()">Ø­ÙØ¸</button>
    <button onclick="closeOffer()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= MAP ================= */
const map = L.map("map").setView([41.05,28.98],15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.firebasestorage.app",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:650a1161841ea510eea2c3"
};
firebase.initializeApp(firebaseConfig);
firebase.auth().signInAnonymously();
const db = firebase.firestore();

/* ================= STATE ================= */
let start=null,end=null;
let startMarker=null,endMarker=null;
let routeLine=null;
let mode="foot";
let follow=true;
let follow = true;

// Ø¥Ø°Ø§ Ù„Ù…Ø³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù†ÙˆÙ‚Ù Ø§Ù„ØªØªØ¨Ø¹
map.on("dragstart",()=>follow=false);
map.on("zoomstart",()=>follow=false);

/* ================= GPS ================= */
navigator.geolocation.watchPosition(p=>{
  start=[p.coords.latitude,p.coords.longitude];
  if(!startMarker) startMarker=L.marker(start).addTo(map);
  else startMarker.setLatLng(start);
  if(follow) map.setView(start,17);
});

/* ================= MODE ================= */
function setMode(m){
  mode=m;
  walkBtn.classList.remove("active");
  carBtn.classList.remove("active");
  if(m==="foot") walkBtn.classList.add("active");
  if(m==="car") carBtn.classList.add("active");
}

/* ================= FOLLOW ================= */
function toggleFollow(){
  follow=!follow;
  info.innerText=follow?"ØªØªØ¨Ø¹ Ø­ÙŠ Ù…ÙØ¹Ù‘Ù„":"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØªØ¨Ø¹";
}

/* ================= DEST ================= */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];
  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map);
  info.innerText="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© âœ”ï¸";
});

/* ================= ROUTING ================= */
function startNav(){
  if(!start||!end){alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø©");return;}

  const profile = mode==="car"?"driving":"foot";
  const url = `https://router.project-osrm.org/route/v1/${profile}/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;

  fetch(url).then(r=>r.json()).then(d=>{
    if(d.code!=="Ok"){alert("Ù„Ù… ÙŠØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø³Ø§Ø±");return;}
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(d.routes[0].geometry,{
      style:{color:"#1976d2",weight:6}
    }).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
    info.innerText="Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø© âœ”ï¸";
  });
}

function cancelNav(){
  if(routeLine) map.removeLayer(routeLine);
  if(endMarker) map.removeLayer(endMarker);
  routeLine=null; end=null;
  info.innerText="ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡";
}

/* ================= OFFERS ================= */
function offerIcon(o){
 let a=o.side==="right"?"â¡ï¸":o.side==="left"?"â¬…ï¸":"â¬†ï¸";
 return L.divIcon({className:"",html:`<div class="offer-badge">${a} ${o.title}</div>`});
}

db.collection("offers").onSnapshot(snap=>{
  snap.docChanges().forEach(c=>{
    if(c.type==="added"){
      const o=c.doc.data();
      L.marker([o.lat,o.lng],{icon:offerIcon(o)}).addTo(map);
    }
  });
});

/* ================= ADD OFFER ================= */
function openOffer(){
 if(!start){alert("Ø§Ù†ØªØ¸Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ");return;}
 offerModal.style.display="flex";
}
function closeOffer(){
 offerModal.style.display="none";
}
function saveOffer(){
 const title=offerTitle.value;
 const side=offerSide.value;
 if(!title){alert("Ø§ÙƒØªØ¨ ÙˆØµÙ");return;}
 db.collection("offers").add({
   title,side,lat:start[0],lng:start[1],
   createdAt:firebase.firestore.FieldValue.serverTimestamp()
 });
 closeOffer();
}
</script>

</body>
</html>

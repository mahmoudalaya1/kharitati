<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:Arial}
#map{position:fixed;inset:0}

/* UI */
#searchBar{
  position:fixed;top:12px;left:50%;
  transform:translateX(-50%);
  width:92%;max-width:460px;
  background:white;padding:12px 16px;
  border-radius:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:1000
}
#bottom{
  position:fixed;bottom:0;left:0;width:100%;
  background:white;border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;z-index:1000
}
#info{text-align:center;font-size:14px;margin-bottom:6px}
.row{display:flex;justify-content:space-around}
button{background:none;border:none;font-size:22px;cursor:pointer}
.active{color:#1976d2;font-weight:bold}
</style>
</head>

<body>

<div id="map"></div>

<div id="searchBar">
  <input placeholder="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø©">
</div>

<div id="bottom">
  <div id="info">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹ Ø«Ù… Ø§Ø¶ØºØ· â–¶ï¸</div>
  <div class="row">
    <button id="carBtn" onclick="setMode('car')">ğŸš—</button>
    <button id="walkBtn" onclick="setMode('walk')">ğŸš¶â€â™‚ï¸</button>
    <button id="bikeBtn" onclick="setMode('bicycle')">ğŸš´</button>
    <button onclick="startNav()">â–¶ï¸</button>
  </div>
</div>

<script>
/* ===== HERE KEY ===== */
const HERE_API_KEY = "PUT_YOUR_API_KEY_HERE";

/* ===== MAP ===== */
const map = L.map("map").setView([41.05, 28.98], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ===== STATE ===== */
let start=null,end=null,startMarker=null,endMarker=null,routeLine=null;
let mode="walk";
setMode("walk");

/* ===== GPS ===== */
navigator.geolocation.getCurrentPosition(
  p=>{
    start=[p.coords.latitude,p.coords.longitude];
    startMarker=L.marker(start).addTo(map);
    map.setView(start,16);
  },
  ()=>alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹"),
  {enableHighAccuracy:true}
);

/* ===== MODE ===== */
function setMode(m){
  mode=m;
  carBtn.classList.remove("active");
  walkBtn.classList.remove("active");
  bikeBtn.classList.remove("active");
  if(m==="car") carBtn.classList.add("active");
  if(m==="walk") walkBtn.classList.add("active");
  if(m==="bicycle") bikeBtn.classList.add("active");
  info.innerText="ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ù‚Ù„: "+(m==="walk"?"Ø§Ù„Ù…Ø´ÙŠ":m==="car"?"Ø§Ù„Ø³ÙŠØ§Ø±Ø©":"Ø§Ù„Ø¯Ø±Ø§Ø¬Ø©");
}

/* ===== DEST ===== */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];
  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map);
  info.innerText="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© âœ”ï¸ Ø§Ø¶ØºØ· â–¶ï¸";
});

/* ===== NAVIGATION WITH FALLBACK ===== */
function startNav(){
  if(!start||!end){alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ù‹Ø§");return;}
  requestRoute(mode,true);
}

function requestRoute(m,allowFallback){
  const url=
    `https://router.hereapi.com/v8/routes?transportMode=${m}`+
    `&routingMode=fast`+
    `&origin=${start[0]},${start[1]}`+
    `&destination=${end[0]},${end[1]}`+
    `&return=polyline,summary&apiKey=${HERE_API_KEY}`;

  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(!d.routes || !d.routes.length){
        if(allowFallback && m==="walk"){
          info.innerText="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù…Ø´ÙŠØŒ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø±Ø©";
          setMode("car");
          requestRoute("car",false);
          return;
        }
        alert("Ù„Ù… ÙŠØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø³Ø§Ø±");
        return;
      }

      if(routeLine) map.removeLayer(routeLine);
      const s=d.routes[0].sections[0];
      routeLine=L.polyline(decode(s.polyline),{color:"#1976d2",weight:6}).addTo(map);

      info.innerText=
        `Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø© (${m==="walk"?"Ù…Ø´ÙŠ":m==="car"?"Ø³ÙŠØ§Ø±Ø©":"Ø¯Ø±Ø§Ø¬Ø©"}) â€“ `+
        `${(s.summary.length/1000).toFixed(1)} ÙƒÙ…`;
    });
}

/* ===== POLYLINE ===== */
function decode(t){
  let p=[],i=0,lat=0,lng=0;
  while(i<t.length){
    let b,s=0,r=0;
    do{b=t.charCodeAt(i++)-63;r|=(b&31)<<s;s+=5}while(b>=32);
    lat+=r&1?~(r>>1):(r>>1);
    s=0;r=0;
    do{b=t.charCodeAt(i++)-63;r|=(b&31)<<s;s+=5}while(b>=32);
    lng+=r&1?~(r>>1):(r>>1);
    p.push([lat/1e5,lng/1e5]);
  }
  return p;
}
</script>

</body>
</html>

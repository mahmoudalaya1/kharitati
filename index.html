<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø®Ø±ÙŠØ·ØªÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%;font-family:Arial}
#map{height:100%}

/* AppBar */
#appBar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#2f3f9e;color:#fff;
  display:flex;align-items:center;
  padding:0 12px;z-index:1200
}
#title{flex:1;font-weight:bold}

/* Ø£Ø²Ø±Ø§Ø± */
.map-btn{
  position:fixed;right:12px;
  width:44px;height:44px;
  background:#fff;border:none;border-radius:8px;
  font-size:20px;
  box-shadow:0 4px 10px rgba(0,0,0,.25);
  cursor:pointer;z-index:1100
}
#zoomIn{top:70px}
#zoomOut{top:120px}
#locate{top:170px;color:#1a73e8}
#startNav{top:230px;background:#1a73e8;color:#fff}
#share{top:290px;color:#ff9500}
#searchBtn{top:350px;color:#7a3df0}

/* Ø¨Ø­Ø« */
#searchBox{
  position:fixed;top:60px;left:50%;
  transform:translateX(-50%);
  width:80%;padding:10px;
  border:none;border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,.3);
  display:none;z-index:2000
}

/* Ø³Ù‡Ù… Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
.arrow{
  width:0;height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:22px solid #1a73e8;
  transform-origin:center;
}
</style>
</head>

<body>

<div id="appBar">
  <div id="title">MAHMOUD ALAYA</div>
</div>

<input id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† ÙˆØ§Ø¶ØºØ· Enter">

<button id="zoomIn" class="map-btn">ï¼‹</button>
<button id="zoomOut" class="map-btn">ï¼</button>
<button id="locate" class="map-btn">âŒ–</button>
<button id="startNav" class="map-btn">â–¶ï¸</button>
<button id="share" class="map-btn">ğŸ“¤</button>
<button id="searchBtn" class="map-btn">ğŸ”</button>

<div id="map"></div>

<script>
/* ===== Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
const map = L.map("map",{zoomControl:false})
  .setView([41.05,28.98],14);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  {maxZoom:19}
).addTo(map);

/* ===== Ù…ØªØºÙŠØ±Ø§Øª ===== */
let userLatLng=null;
let arrowMarker=null;
let destination=null;
let routeLine=null;
let navigating=false;
let compassAngle=0;

/* ===== Ø£Ø²Ø±Ø§Ø± ===== */
zoomIn.onclick=()=>map.zoomIn();
zoomOut.onclick=()=>map.zoomOut();

/* ===== GPS Ø­ÙŠ ===== */
locate.onclick=()=>{
  map.locate({
    watch:true,
    setView:true,
    enableHighAccuracy:true
  });
};

map.on("locationfound",e=>{
  userLatLng=e.latlng;

  if(!arrowMarker){
    arrowMarker=L.marker(userLatLng,{
      icon:L.divIcon({
        className:"",
        html:'<div class="arrow"></div>',
        iconSize:[22,22],
        iconAnchor:[11,11]
      })
    }).addTo(map);
  }else{
    arrowMarker.setLatLng(userLatLng);
  }

  if(navigating && destination){
    drawRoute();
  }
});

/* ===== Ø¨ÙˆØµÙ„Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© ===== */
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation",e=>{
    if(e.alpha!==null){
      compassAngle=360-e.alpha;
      if(arrowMarker){
        const el=arrowMarker.getElement();
        if(el) el.style.transform=`rotate(${compassAngle}deg)`;
      }
    }
  },true);
}

/* ===== Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ù‡Ø© ===== */
map.on("click",e=>{
  destination=e.latlng;
  L.marker(destination).addTo(map)
    .bindPopup("ğŸ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©").openPopup();
});

/* ===== Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± ===== */
function drawRoute(){
  if(!userLatLng||!destination) return;

  const url=
   `https://router.project-osrm.org/route/v1/driving/`+
   `${userLatLng.lng},${userLatLng.lat};`+
   `${destination.lng},${destination.lat}`+
   `?overview=full&geometries=geojson`;

  fetch(url).then(r=>r.json()).then(d=>{
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.geoJSON(d.routes[0].geometry,{
      style:{color:"#1a73e8",weight:6}
    }).addTo(map);
  });
}

/* ===== Ø¨Ø¯Ø¡ Ù…Ø´ÙˆØ§Ø± ===== */
startNav.onclick=()=>{
  if(!userLatLng||!destination){
    alert("Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø©");
    return;
  }
  navigating=true;
  drawRoute();
};

/* ===== Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ ===== */
share.onclick=()=>{
  if(!userLatLng){
    alert("Ø´ØºÙ‘Ù„ GPS Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }
  const link=`https://www.google.com/maps?q=${userLatLng.lat},${userLatLng.lng}`;
  navigator.clipboard.writeText(link);
  alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹Ùƒ");
};

/* ===== Ø¨Ø­Ø« ===== */
searchBtn.onclick=()=>{
  searchBox.style.display=
    searchBox.style.display==="block"?"none":"block";
};

searchBox.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${searchBox.value}`)
      .then(r=>r.json())
      .then(d=>{
        if(!d.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±");
        map.setView([d[0].lat,d[0].lon],16);
        searchBox.style.display="none";
      });
  }
});
</script>

</body>
</html>

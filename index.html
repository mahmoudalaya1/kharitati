<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
  font-family:Arial
}
#map{position:fixed;inset:0}

/* Bottom bar */
#bottom{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:white;
  border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;
  z-index:1000
}
#info{
  text-align:center;
  font-size:14px;
  margin-bottom:6px
}
.row{
  display:flex;
  justify-content:space-around;
  align-items:center
}
button{
  background:none;
  border:none;
  font-size:22px;
  cursor:pointer
}
.active{color:#1976d2;font-weight:bold}
</style>
</head>

<body>

<div id="map"></div>

<div id="bottom">
  <div id="info">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø©</div>
  <div class="row">
    <button id="walkBtn" onclick="setMode('foot')">ğŸš¶â€â™‚ï¸</button>
    <button id="carBtn" onclick="setMode('car')">ğŸš—</button>
    <button onclick="startNav()">â–¶ï¸</button>
    <button onclick="cancelNav()">âŒ</button>
    <button onclick="goBack()">ğŸ”™</button>
  </div>
</div>

<script>
/* ================= MAP ================= */
const map = L.map("map").setView([41.05,28.98],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ================= STATE ================= */
let start=null,end=null;
let startMarker=null,endMarker=null;
let routeLine=null;
let mode="foot";
let follow=true;
let historyState=null;

/* ================= GPS (FOLLOW ME) ================= */
navigator.geolocation.watchPosition(
  p=>{
    start=[p.coords.latitude,p.coords.longitude];
    if(!startMarker) startMarker=L.marker(start).addTo(map);
    else startMarker.setLatLng(start);

    if(follow) map.setView(start,17,{animate:true});
  },
  ()=>alert("GPS ØºÙŠØ± Ù…ØªØ§Ø­"),
  {enableHighAccuracy:true}
);

/* ================= MODE ================= */
function setMode(m){
  mode=m;
  walkBtn.classList.remove("active");
  carBtn.classList.remove("active");
  if(m==="foot") walkBtn.classList.add("active");
  if(m==="car") carBtn.classList.add("active");

  speak(m==="foot"?"ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´ÙŠ":"ÙˆØ¶Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©");
}

/* ================= DEST ================= */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];

  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map);

  historyState={end:[...end]};

  info.innerText="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© âœ”ï¸ Ø§Ø¶ØºØ· â–¶ï¸";
});

/* ================= START NAV ================= */
function startNav(){
  if(!start||!end){
    alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ù‹Ø§");
    return;
  }

  const url =
    `https://router.project-osrm.org/route/v1/${mode}/`+
    `${start[1]},${start[0]};${end[1]},${end[0]}`+
    `?overview=full&geometries=geojson&steps=true`;

  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(d.code!=="Ok"){
        alert("Ù„Ù… ÙŠØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø³Ø§Ø±");
        return;
      }

      if(routeLine) map.removeLayer(routeLine);

      routeLine=L.geoJSON(d.routes[0].geometry,{
        style:{color:"#1976d2",weight:6}
      }).addTo(map);

      const dist=(d.routes[0].distance/1000).toFixed(1);
      info.innerText=`Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø© â€“ ${dist} ÙƒÙ…`;

      speak("Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³ÙŠØ±");
      speakSteps(d.routes[0].legs[0].steps);
    });
}

/* ================= CANCEL ================= */
function cancelNav(){
  if(routeLine) map.removeLayer(routeLine);
  if(endMarker) map.removeLayer(endMarker);
  routeLine=null;
  endMarker=null;
  end=null;
  info.innerText="ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ âŒ";
  speak("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø©");
}

/* ================= BACK (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ================= */
function goBack(){
  if(!historyState){
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¬ÙˆØ¹");
    return;
  }
  end=[...historyState.end];
  endMarker=L.marker(end).addTo(map);
  info.innerText="ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø© ğŸ”™";
  historyState=null;
}

/* ================= VOICE ================= */
function speak(text){
  const u=new SpeechSynthesisUtterance(text);
  u.lang="ar";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function speakSteps(steps){
  let i=0;
  function next(){
    if(i>=steps.length) return;
    speak(steps[i].maneuver.instruction || "ØªØ§Ø¨Ø¹");
    i++;
    setTimeout(next,4000);
  }
  next();
}
</script>

</body>
</html>

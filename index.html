<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Chat Friends</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}

/* LOGIN */
#loginBox{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#ece5dd;
  z-index:1000;
}
.box{
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:300px;
  text-align:center;
}
.box input{
  width:100%;
  padding:10px;
  margin:5px 0;
}
.box button{
  width:100%;
  padding:10px;
  background:#2ecc71;
  border:none;
  color:#fff;
  cursor:pointer;
}

/* CHAT */
#chatBox{
  display:none;
  height:100vh;
}
.chat{
  display:flex;
  height:100%;
}
.sidebar{
  width:30%;
  background:#fff;
  border-left:1px solid #ccc;
  overflow:auto;
}
.messages{
  flex:1;
  display:flex;
  flex-direction:column;
}
.header{
  background:#075e54;
  color:#fff;
  padding:10px;
  text-align:center;
}
.list div{
  padding:10px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.list div:hover{background:#f0f0f0}
.msgs{
  flex:1;
  padding:10px;
  overflow:auto;
}
.msg{
  background:#dcf8c6;
  margin:5px;
  padding:8px;
  border-radius:6px;
  max-width:70%;
}
.me{margin-left:auto;background:#b2f2bb}
.input{display:flex}
.input input{flex:1;padding:10px}
.input button{
  padding:10px;
  background:#25d366;
  border:none;
  color:#fff;
  cursor:pointer;
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDr5hql0t0eI0AYi7-_xLZfYpFw8F6vXRA",
  authDomain: "kharitati-5cb37.firebaseapp.com",
  projectId: "kharitati-5cb37",
  storageBucket: "kharitati-5cb37.appspot.com",
  messagingSenderId: "296218682746",
  appId: "1:296218682746:web:650a1161841ea510eea2c3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <div class="box">
    <h3>ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</h3>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·)">
    <button onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- CHAT -->
<div id="chatBox">
  <div class="chat">
    <div class="sidebar">
      <div class="header">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</div>
      <div class="list" id="friends"></div>
    </div>

    <div class="messages">
      <div class="header" id="chatHeader">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚</div>
      <div class="msgs" id="msgs"></div>
      <div class="input">
        <input id="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
        <button onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentChat = null;

/* ðŸ” AUTH STATE */
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.style.display="none";
    chatBox.style.display="block";
    loadUsers();
  }else{
    loginBox.style.display="flex";
    chatBox.style.display="none";
  }
});

/* LOGIN / REGISTER */
function doLogin(){
  if(!email.value || !pass.value){
    alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    return;
  }

  auth.signInWithEmailAndPassword(email.value, pass.value)
  .catch(err=>{
    if(err.code === "auth/user-not-found"){
      if(!username.value){
        alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨");
        return;
      }

      auth.createUserWithEmailAndPassword(email.value, pass.value)
      .then(cred=>{
        return db.collection("users").doc(cred.user.uid).set({
          username: username.value,
          email: email.value
        });
      })
      .catch(e=>alert(e.message));

    }else if(err.code === "auth/wrong-password"){
      alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }else{
      alert(err.message);
    }
  });
}

/* LOAD USERS */
function loadUsers(){
  db.collection("users").onSnapshot(s=>{
    friends.innerHTML="";
    s.forEach(d=>{
      if(d.id === auth.currentUser.uid) return;
      const div=document.createElement("div");
      div.innerText=d.data().username;
      div.onclick=()=>openChat(d.id,d.data().username);
      friends.appendChild(div);
    });
  });
}

/* CHAT */
function openChat(fid,name){
  currentChat=[auth.currentUser.uid,fid].sort().join("_");
  chatHeader.innerText=name;
  listen();
}

function send(){
  if(!text.value || !currentChat) return;
  db.collection("chats").doc(currentChat)
  .collection("messages").add({
    text:text.value,
    from:auth.currentUser.uid,
    time:Date.now()
  });
  text.value="";
}

function listen(){
  db.collection("chats").doc(currentChat)
  .collection("messages").orderBy("time")
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      const m=document.createElement("div");
      m.className="msg"+(d.data().from===auth.currentUser.uid?" me":"");
      m.innerText=d.data().text;
      msgs.appendChild(m);
    });
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø®Ø±ÙŠØ·ØªÙŠ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#map { height:100vh; }

/* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
#loginBox {
  position: fixed;
  inset: 0;
  background: #f5f5f5;
  z-index: 20000;
  display: flex;
  align-items: center;
  justify-content: center;
}
#loginBox .box {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 280px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  text-align: center;
}
#loginBox input {
  width:100%;
  padding:8px;
  margin-bottom:10px;
}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ø¨Ø­Ø« */
.panel {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 8px;
  width: 220px;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}
.panel input {
  width:100%;
  padding:6px;
  margin-bottom:6px;
}
.panel button {
  width:100%;
  padding:7px;
  background:#2196f3;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
.controls {
  position: fixed;
  top: 15px;
  right: 10px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.ctrl {
  padding: 10px 14px;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.save { background:#4caf50; }
.edit { background:#ff9800; }
.del  { background:#f44336; }

/* Ø²Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ */
#accountBtn {
  position: fixed;
  top: 15px;
  right: 90px;
  z-index: 9999;
  background: white;
  border: 1px solid #ccc;
  border-radius: 20px;
  padding: 6px 12px;
  cursor: pointer;
  display: none;
}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ */
#accountMenu {
  position: fixed;
  top: 55px;
  right: 90px;
  z-index: 10000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  padding: 10px;
  display: none;
  width: 200px;
}

/* Ø²Ø± Ø§Ù„Ø·Ø¨Ù‚Ø§Øª */
.leaflet-top.leaflet-left {
  margin-left: 20px;
}
</style>
</head>

<body>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginBox">
  <div class="box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <button onclick="login()" style="width:100%;padding:10px;background:#2196f3;color:white;border:none;border-radius:6px">
      Ø¯Ø®ÙˆÙ„
    </button>
  </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ -->
<button id="accountBtn" onclick="toggleAccount()">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ -->
<div id="accountMenu">
  <div id="accountEmail" style="margin-bottom:8px;font-size:14px"></div>
  <button onclick="logout()" style="width:100%;padding:8px;background:#f44336;color:white;border:none;border-radius:6px">
    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
  </button>
</div>

<div class="panel">
  <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†">
  <button onclick="searchPlace()">ğŸ” Ø¨Ø­Ø«</button>
  <button style="margin-top:5px" onclick="locateMe()">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
</div>

<div class="controls">
  <button class="ctrl save" onclick="savePlace()">â­ Ø­ÙØ¸</button>
  <button class="ctrl edit" onclick="editPlace()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
  <button class="ctrl del" onclick="deletePlace()">ğŸ—‘ï¸ Ù…Ø³Ø­</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
if(localStorage.getItem("user")){
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("accountBtn").style.display = "block";
  document.getElementById("accountEmail").innerText = localStorage.getItem("user");
}

function login(){
  const email = document.getElementById("loginEmail").value;
  if(!email) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯");
  localStorage.setItem("user", email);
  location.reload();
}

function logout(){
  localStorage.removeItem("user");
  location.reload();
}

function toggleAccount(){
  const m = document.getElementById("accountMenu");
  m.style.display = m.style.display === "block" ? "none" : "block";
}

/* ===== Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
const map = L.map('map').setView([33.5138, 36.2765], 6);
let marker = null;
let editMode = false;

/* ===== Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ===== */
const normalMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const satelliteMap = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
);
const terrainMap = L.tileLayer(
  'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'
);
const trafficMap = L.tileLayer(
  'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'
);

normalMap.addTo(map);

L.control.layers(
  {
    "ğŸ—ºï¸ Ø¹Ø§Ø¯ÙŠØ©": normalMap,
    "ğŸ›°ï¸ Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ": satelliteMap,
    "ğŸ—» ØªØ¶Ø§Ø±ÙŠØ³": terrainMap
  },
  {
    "ğŸš¦ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø±ÙˆØ±": trafficMap
  },
  { position: 'topleft' }
).addTo(map);

/* ===== Ø§Ù„Ø¨Ø­Ø« ===== */
function searchPlace(){
  const q = document.getElementById("search").value;
  if(!q) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†");

  fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±");
      setMarker(d[0].lat, d[0].lon, "ğŸ“ "+d[0].display_name);
      map.setView([d[0].lat, d[0].lon], 15);
    });
}

/* ===== Ù…ÙˆÙ‚Ø¹ÙŠ ===== */
function locateMe(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude, accuracy} = pos.coords;
    setMarker(latitude, longitude, "ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ<br>Ø§Ù„Ø¯Ù‚Ø©: "+Math.round(accuracy)+"Ù…");
    map.setView([latitude, longitude], 17);
  });
}

/* ===== Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===== */
map.on('click', e=>{
  if(!editMode && marker) return;
  setMarker(e.latlng.lat, e.latlng.lng, "ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯");
  editMode = false;
});

/* ===== Ø£Ø¯ÙˆØ§Øª ===== */
function setMarker(lat,lon,text){
  if(marker) map.removeLayer(marker);
  marker = L.marker([lat,lon]).addTo(map).bindPopup(text).openPopup();
}
function savePlace(){
  if(!marker) return alert("Ø­Ø¯Ø¯ Ù…ÙƒØ§Ù†");
  localStorage.setItem("savedPlace", JSON.stringify(marker.getLatLng()));
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
}
function editPlace(){
  if(!marker) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù†");
  editMode = true;
}
function deletePlace(){
  if(!marker) return;
  map.removeLayer(marker);
  marker = null;
  localStorage.removeItem("savedPlace");
}
</script>

</body>
</html>

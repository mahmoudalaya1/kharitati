<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body,#map{height:100%;margin:0;font-family:Arial}
#map{z-index:1}

/* Search */
#searchBar{
  position:absolute;top:12px;left:50%;
  transform:translateX(-50%);
  width:92%;max-width:460px;
  background:white;padding:12px 16px;
  border-radius:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:999
}
#searchBar input{border:none;width:100%;font-size:16px;outline:none}
#results{font-size:14px}

/* Bottom Bar */
#bottom{
  position:absolute;bottom:0;left:0;
  width:100%;background:white;
  border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;
  z-index:999
}
#bottom .row{
  display:flex;justify-content:space-around;
  align-items:center
}
#bottom button{
  background:none;border:none;
  font-size:22px;cursor:pointer
}
#info{text-align:center;font-size:14px;margin-bottom:6px}

/* Arrow */
#arrow{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  font-size:42px;z-index:998;pointer-events:none
}
</style>
</head>

<body>

<div id="map"></div>
<div id="arrow">â¬†ï¸</div>

<div id="searchBar">
  <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†">
  <div id="results"></div>
</div>

<div id="bottom">
  <div id="info">Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø©</div>
  <div class="row">
    <button onclick="setMode('car')">ğŸš—</button>
    <button onclick="setMode('pedestrian')">ğŸš¶</button>
    <button onclick="setMode('bicycle')">ğŸš´</button>
    <button onclick="toggleTraffic()">ğŸš¦</button>
    <button onclick="startNav()">â–¶ï¸</button>
    <button onclick="locate()">ğŸ“</button>
    <button onclick="toggleFollow()">ğŸ§­</button>
  </div>
</div>

<script>
/* ================= HERE KEY (Ø¬Ø§Ù‡Ø²) ================= */
const HERE_API_KEY = "2bawjGyMywU1LuL_85lz84eIGOdGpAkIHTKwqOEVt8";

/* ================= MAP ================= */
const map = L.map("map",{zoomControl:false}).setView([36.2,37.13],15);

L.tileLayer(
  "https://{s}.base.maps.ls.hereapi.com/maptile/2.1/maptile/newest/normal.day/{z}/{x}/{y}/256/png8?apiKey="+HERE_API_KEY,
  {subdomains:["1","2","3","4"]}
).addTo(map);

const trafficLayer = L.tileLayer(
  "https://{s}.traffic.maps.ls.hereapi.com/maptile/2.1/flowtile/newest/normal.day/{z}/{x}/{y}/256/png8?apiKey="+HERE_API_KEY,
  {subdomains:["1","2","3","4"]}
);

let trafficOn=false;
function toggleTraffic(){
  trafficOn?map.removeLayer(trafficLayer):map.addLayer(trafficLayer);
  trafficOn=!trafficOn;
}

/* ================= STATE ================= */
let start=null,end=null,marker=null,follow=true,mode="car";
let routeLine=null;

/* ================= LOCATION ================= */
navigator.geolocation.watchPosition(
  p=>{
    start=L.latLng(p.coords.latitude,p.coords.longitude);
    if(!marker) marker=L.marker(start).addTo(map);
    else marker.setLatLng(start);
    if(follow) map.setView(start,17,{animate:true});
    if(routeLine && end) drawRoute();
  },
  ()=>alert("GPS Error"),
  {enableHighAccuracy:true}
);

/* ================= ROUTING ================= */
function setMode(m){ mode=m; }

function startNav(){
  if(!start || !end){
    alert("Ø­Ø¯Ø¯ ÙˆØ¬Ù‡Ø©");
    return;
  }
  drawRoute();
}

function drawRoute(){
  const url =
  `https://router.hereapi.com/v8/routes?transportMode=${mode}&origin=${start.lat},${start.lng}&destination=${end.lat},${end.lng}&return=polyline,summary&apiKey=${HERE_API_KEY}`;

  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(routeLine) map.removeLayer(routeLine);
      const section=d.routes[0].sections[0];
      routeLine=L.polyline(decodePolyline(section.polyline),{
        color:"#1976d2",weight:6
      }).addTo(map);

      document.getElementById("info").innerText =
        `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${(section.summary.length/1000).toFixed(1)} ÙƒÙ… â€“ ${(section.summary.duration/60).toFixed(0)} Ø¯Ù‚ÙŠÙ‚Ø©`;
    });
}

/* Polyline decode */
function decodePolyline(encoded){
  let points=[],index=0,lat=0,lng=0;
  while(index<encoded.length){
    let b,shift=0,result=0;
    do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);
    lat+=((result&1)?~(result>>1):(result>>1));
    shift=0;result=0;
    do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);
    lng+=((result&1)?~(result>>1):(result>>1));
    points.push([lat/1e5,lng/1e5]);
  }
  return points;
}

/* ================= MAP CLICK ================= */
map.on("click",e=>{
  end=e.latlng;
  document.getElementById("info").innerText="Ø§Ø¶ØºØ· â–¶ï¸ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø©";
});

/* ================= TOOLS ================= */
function locate(){ if(start) map.setView(start,17,{animate:true}); }
function toggleFollow(){ follow=!follow; }

/* ================= SEARCH ================= */
const search=document.getElementById("search");
const results=document.getElementById("results");

search.oninput=()=>{
  if(search.value.length<3){results.innerHTML="";return;}
  fetch(`https://geocode.search.hereapi.com/v1/geocode?q=${search.value}&apiKey=${HERE_API_KEY}`)
    .then(r=>r.json())
    .then(d=>{
      results.innerHTML="";
      d.items.slice(0,5).forEach(p=>{
        const div=document.createElement("div");
        div.textContent=p.title;
        div.onclick=()=>{
          end=L.latLng(p.position.lat,p.position.lng);
          map.setView(end,15);
          results.innerHTML="";
          document.getElementById("info").innerText="Ø§Ø¶ØºØ· â–¶ï¸ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø©";
        };
        results.appendChild(div);
      });
    });
};

/* ================= ARROW ================= */
window.addEventListener("deviceorientation",e=>{
  if(e.alpha){
    document.getElementById("arrow").style.transform =
      `translate(-50%,-50%) rotate(${e.alpha}deg)`;
  }
});
</script>

</body>
</html>

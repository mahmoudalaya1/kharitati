<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>My Maps Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
html,body,#map{height:100%;margin:0;font-family:Arial}
#map{z-index:1}
#arrow{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:40px;z-index:999}
#panel{
  position:absolute;bottom:0;width:100%;
  background:white;padding:14px;
  border-radius:20px 20px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  z-index:999
}
#btns{
  position:absolute;right:10px;top:80px;
  display:flex;flex-direction:column;gap:8px;
  z-index:999
}
#btns button{
  width:50px;height:50px;border:none;
  border-radius:50%;font-size:22px;
  background:white;box-shadow:0 3px 10px rgba(0,0,0,.3)
}
</style>
</head>

<body>

<div id="map"></div>
<div id="arrow">‚¨ÜÔ∏è</div>

<div id="btns">
  <button onclick="toggleTraffic()">üö¶</button>
  <button onclick="toggleFollow()">üß≠</button>
</div>

<div id="panel">
  <b id="step">ÿ¨ÿßŸáÿ≤ ŸÑŸÑŸÖŸÑÿßÿ≠ÿ©</b><br>
  <span id="eta">---</span>
</div>

<script>
/* ================= MAP ================= */
const map=L.map("map",{zoomControl:false}).setView([36.2,37.13],15);
const normal=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* üü° Traffic Layer */
const traffic=L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png");
let trafficOn=false;
function toggleTraffic(){
  trafficOn?map.removeLayer(traffic):map.addLayer(traffic);
  trafficOn=!trafficOn;
}

/* üî¥ ÿ¨ÿßŸáÿ≤ ŸÑŸÄ Traffic API ÿ≠ŸÇŸäŸÇŸä (ŸÖÿ´ÿßŸÑ Mapbox)
const trafficReal = L.tileLayer(
  `https://api.mapbox.com/styles/v1/mapbox/traffic-day-v2/tiles/{z}/{x}/{y}?access_token=PUT_API_KEY_HERE`
);
*/

/* ================= LOCATION ================= */
let start=null,end=null,route=null;
let marker=null,follow=true;
let lastPos=null;

navigator.geolocation.watchPosition(p=>{
  start=L.latLng(p.coords.latitude,p.coords.longitude);
  if(!marker) marker=L.marker(start).addTo(map);
  else marker.setLatLng(start);

  if(follow) map.setView(start,17,{animate:true});
  if(route) route.setWaypoints([start,end]);
},{},{enableHighAccuracy:true});

/* ================= VOICE ================= */
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang=navigator.language.startsWith("ar")?"ar":"en";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ================= NAVIGATION ================= */
map.on("click",e=>{
  end=e.latlng;
  if(route) map.removeControl(route);

  route=L.Routing.control({
    waypoints:[start,end],
    router:L.Routing.osrmv1(),
    addWaypoints:false,
    show:false
  })
  .on("routesfound",e=>{
    const r=e.routes[0];
    document.getElementById("eta").innerText=
      `ÿßŸÑŸÖÿ™ÿ®ŸÇŸä ${(r.summary.totalDistance/1000).toFixed(1)} ŸÉŸÖ | ${(r.summary.totalTime/60).toFixed(0)} ÿØ`;

    r.instructions.forEach(i=>{
      if(i.distance<100) speak("ÿ®ÿπÿØ ŸÖÿ¶ÿ© ŸÖÿ™ÿ± " + i.text);
      if(i.distance<50) speak("ÿßŸÑÿ¢ŸÜ " + i.text);
    });
  })
  .addTo(map);
});

/* ================= FOLLOW ================= */
function toggleFollow(){
  follow=!follow;
  speak(follow?"ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ™ÿ®ÿπ":"ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ™ÿ®ÿπ");
}

/* ================= ARROW ================= */
window.addEventListener("deviceorientation",e=>{
  if(e.alpha)
    document.getElementById("arrow").style.transform=
      `translate(-50%,-50%) rotate(${e.alpha}deg)`;
});

/* ================= OFFLINE (PWA CACHE) ================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>

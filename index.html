<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Walk</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
  font-family:Arial
}
#map{
  position:fixed;
  inset:0;
}
#bottom{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:white;
  border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;
  z-index:1000;
}
#info{
  text-align:center;
  font-size:14px;
  margin-bottom:6px;
}
.row{
  display:flex;
  justify-content:center;
}
button{
  background:#1976d2;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:20px;
  font-size:18px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="bottom">
  <div id="info">اضغط على الخريطة لتحديد وجهة</div>
  <div class="row">
    <button onclick="startNav()">▶️ ابدأ المشي</button>
  </div>
</div>

<script>
/* ===== MAP ===== */
const map = L.map("map").setView([41.05, 28.98], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ===== STATE ===== */
let start=null,end=null,startMarker=null,endMarker=null,routeLine=null;

/* ===== GPS ===== */
navigator.geolocation.getCurrentPosition(
  p=>{
    start=[p.coords.latitude,p.coords.longitude];
    startMarker=L.marker(start).addTo(map);
    map.setView(start,16);
  },
  ()=>alert("لم يتم السماح بتحديد الموقع"),
  {enableHighAccuracy:true}
);

/* ===== DEST ===== */
map.on("click",e=>{
  end=[e.latlng.lat,e.latlng.lng];
  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end).addTo(map);
  info.innerText="تم تحديد الوجهة ✔️ اضغط ▶️";
});

/* ===== WALK ROUTE (OSRM) ===== */
function startNav(){
  if(!start||!end){
    alert("حدد وجهة أولًا");
    return;
  }

  const url =
    `https://router.project-osrm.org/route/v1/foot/`+
    `${start[1]},${start[0]};${end[1]},${end[0]}`+
    `?overview=full&geometries=geojson`;

  fetch(url)
    .then(r=>r.json())
    .then(d=>{
      if(d.code!=="Ok"){
        alert("لم يتم إيجاد مسار مشي");
        return;
      }

      if(routeLine) map.removeLayer(routeLine);

      routeLine=L.geoJSON(d.routes[0].geometry,{
        style:{color:"#1976d2",weight:6}
      }).addTo(map);

      info.innerText =
        `بدأ المشي – ${(d.routes[0].distance/1000).toFixed(1)} كم`;
    });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati GPS Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;height:100%}
#map{height:100%}

/* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ */
#locateBtn{
  position:fixed;
  bottom:90px;
  right:16px;
  z-index:1000;
  background:white;
  border:none;
  border-radius:50%;
  width:56px;
  height:56px;
  font-size:24px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  cursor:pointer;
}

/* Ø³Ù‡Ù… Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
.arrow{
  width:0;
  height:0;
  border-left:10px solid transparent;
  border-right:10px solid transparent;
  border-bottom:22px solid #1976d2;
  transform-origin:center;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="locateBtn" onclick="centerOnMe()">ğŸ“</button>

<script>
/* ================= MAP ================= */
const map = L.map("map", {
  zoomControl:true
}).setView([41.05,28.98],15);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:19
}).addTo(map);

/* ================= STATE ================= */
let userMarker = null;
let follow = true;
let lastHeading = 0;

/* ================= ICON ================= */
const arrowIcon = L.divIcon({
  className:"",
  html:`<div class="arrow"></div>`,
  iconSize:[22,22],
  iconAnchor:[11,11]
});

/* ================= STOP FOLLOW ON MOVE ================= */
map.on("dragstart",()=>follow=false);
map.on("zoomstart",()=>follow=false);

/* ================= GPS ================= */
if(!navigator.geolocation){
  alert("âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
}else{
  navigator.geolocation.watchPosition(
    pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const heading = pos.coords.heading ?? lastHeading;

      lastHeading = heading;

      if(!userMarker){
        userMarker = L.marker([lat,lng],{icon:arrowIcon}).addTo(map);
        map.setView([lat,lng],17);
      }else{
        userMarker.setLatLng([lat,lng]);
      }

      // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø³Ù‡Ù…
      const el = userMarker.getElement();
      if(el){
        el.style.transform = `rotate(${heading}deg)`;
      }

      // Follow ÙƒØ§Ù…Ù„
      if(follow){
        map.setView([lat,lng], map.getZoom(), {animate:true});
      }
    },
    err=>{
      alert("âŒ Ù„Ø§Ø²Ù… ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­");
      console.error(err);
    },
    { enableHighAccuracy:true }
  );
}

/* ================= BUTTON ================= */
function centerOnMe(){
  follow = true;
  if(userMarker){
    map.setView(userMarker.getLatLng(),17);
  }
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Kharitati Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
  font-family:Arial
}

/* الخريطة */
#map{
  position:fixed;
  inset:0;
  z-index:1;
}

/* شريط البحث (لا يلتقط النقر) */
#searchBar{
  position:fixed;
  top:12px;
  left:50%;
  transform:translateX(-50%);
  width:92%;
  max-width:460px;
  background:white;
  padding:12px 16px;
  border-radius:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:1000;
  pointer-events:none;
}
#searchBar input{
  width:100%;
  border:none;
  outline:none;
  font-size:16px;
  pointer-events:auto;
}

/* الشريط السفلي (لا يلتقط النقر) */
#bottom{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:white;
  border-radius:22px 22px 0 0;
  box-shadow:0 -4px 20px rgba(0,0,0,.3);
  padding:10px;
  z-index:1000;
  pointer-events:none;
}
#bottom .row button{
  background:none;
  border:none;
  font-size:22px;
  pointer-events:auto;
}
#info{
  text-align:center;
  font-size:14px;
  margin-bottom:6px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="searchBar">
  <input placeholder="ابحث عن مكان (اختياري)">
</div>

<div id="bottom">
  <div id="info">اضغط على الخريطة لتحديد الوجهة</div>
  <div class="row">
    <button onclick="startNav()">▶️</button>
  </div>
</div>

<script>
/* ===== HERE KEY ===== */
const HERE_API_KEY = "PUT_YOUR_API_KEY_HERE";

/* ===== MAP ===== */
const map = L.map("map").setView([36.2,37.13],13);

L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {maxZoom:19}
).addTo(map);

/* ===== STATE ===== */
let start=null;
let end=null;
let startMarker=null;
let endMarker=null;
let routeLine=null;

/* ===== GPS ===== */
navigator.geolocation.getCurrentPosition(
  p=>{
    start=[p.coords.latitude,p.coords.longitude];
    startMarker=L.marker(start).addTo(map);
    map.setView(start,16);
  },
  ()=>alert("لم يتم السماح بالموقع"),
  {enableHighAccuracy:true}
);

/* ===== CLICK TO SET DESTINATION (مهم) ===== */
map.on("click", e=>{
  end=[e.latlng.lat, e.latlng.lng];

  if(endMarker) map.removeLayer(endMarker);
  endMarker=L.marker(end,{title:"الوجهة"}).addTo(map);

  document.getElementById("info").innerText =
    "تم تحديد الوجهة ✔️ اضغط ▶️ لبدء الملاحة";
});

/* ===== ROUTING ===== */
function startNav(){
  if(!start || !end){
    alert("حدد وجهة على الخريطة أولًا");
    return;
  }

  fetch(
    `https://router.hereapi.com/v8/routes?transportMode=car&origin=${start[0]},${start[1]}&destination=${end[0]},${end[1]}&return=polyline,summary&apiKey=${HERE_API_KEY}`
  )
  .then(r=>r.json())
  .then(d=>{
    if(routeLine) map.removeLayer(routeLine);
    const s=d.routes[0].sections[0];
    routeLine=L.polyline(decode(s.polyline),{
      color:"#1976d2",weight:6
    }).addTo(map);

    document.getElementById("info").innerText =
      `المتبقي ${(s.summary.length/1000).toFixed(1)} كم`;
  });
}

/* ===== POLYLINE DECODE ===== */
function decode(t){
  let p=[],i=0,lat=0,lng=0;
  while(i<t.length){
    let b,s=0,r=0;
    do{b=t.charCodeAt(i++)-63;r|=(b&31)<<s;s+=5}while(b>=32);
    lat+=r&1?~(r>>1):(r>>1);
    s=0;r=0;
    do{b=t.charCodeAt(i++)-63;r|=(b&31)<<s;s+=5}while(b>=32);
    lng+=r&1?~(r>>1):(r>>1);
    p.push([lat/1e5,lng/1e5]);
  }
  return p;
}
</script>

</body>
</html>
ر
